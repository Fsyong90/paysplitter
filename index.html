<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PayNow Lunch Splitter</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .app-container {
            max-width: 600px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            color: white;
            margin-bottom: 20px;
            position: relative;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 5px;
        }

        .header p {
            opacity: 0.9;
            font-size: 14px;
        }

        .settings-btn {
            position: absolute;
            top: 0;
            right: 0;
            background: rgba(255,255,255,0.2);
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 20px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .settings-btn:hover {
            background: rgba(255,255,255,0.3);
        }
        
        .card {
            background: white;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }
        
        .card-title {
            font-size: 16px;
            font-weight: 700;
            color: #333;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .card-title .icon {
            font-size: 20px;
        }
        
        /* People Section */
        .people-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 12px;
        }
        
        .person-tag {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 10px 14px;
            background: linear-gradient(135deg, #7B2D8E, #E91E8C);
            color: white;
            border-radius: 20px;
            font-size: 15px;
            font-weight: 500;
            min-height: 44px;
        }

        .person-tag .remove {
            cursor: pointer;
            opacity: 0.8;
            font-size: 20px;
            padding: 4px;
            min-width: 28px;
            min-height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .person-tag .remove:hover {
            opacity: 1;
        }
        
        .add-person-row {
            display: flex;
            gap: 8px;
        }
        
        .add-person-input {
            flex: 1;
            padding: 12px 14px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 16px;
            outline: none;
            min-height: 48px;
        }

        .add-person-input:focus {
            border-color: #7B2D8E;
        }

        .add-btn {
            padding: 12px 20px;
            background: #7B2D8E;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            min-height: 48px;
            min-width: 80px;
        }

        .add-btn:hover {
            background: #5a1f6a;
        }
        
        /* Items Section */
        .item-row {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 14px;
            margin-bottom: 10px;
            position: relative;
            transition: transform 0.2s, opacity 0.2s;
        }

        .item-row.swiping {
            transform: translateX(-80px);
        }

        .item-row.removing {
            transform: translateX(-100%);
            opacity: 0;
        }

        .item-main {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
            align-items: center;
        }

        .item-name {
            flex: 2;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 16px;
            outline: none;
            background: white;
            min-height: 48px;
        }

        .item-name:focus {
            border-color: #7B2D8E;
        }

        .item-price {
            width: 90px;
            padding: 12px 8px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 16px;
            outline: none;
            text-align: right;
            background: white;
            min-height: 48px;
        }

        .item-price:focus {
            border-color: #7B2D8E;
        }

        .remove-item-btn {
            width: 48px;
            height: 48px;
            border: none;
            background: #fee;
            color: #e74c3c;
            border-radius: 8px;
            cursor: pointer;
            font-size: 22px;
            flex-shrink: 0;
        }

        .remove-item-btn:hover, .remove-item-btn:active {
            background: #e74c3c;
            color: white;
        }
        
        .item-people {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }
        
        .item-people-label {
            font-size: 12px;
            color: #888;
            width: 100%;
            margin-bottom: 4px;
        }
        
        .person-checkbox {
            display: none;
        }
        
        .person-label {
            padding: 10px 14px;
            background: #e9ecef;
            border-radius: 20px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            user-select: none;
            min-height: 40px;
            display: inline-flex;
            align-items: center;
        }

        .person-checkbox:checked + .person-label {
            background: linear-gradient(135deg, #7B2D8E, #E91E8C);
            color: white;
        }
        
        .add-item-btn {
            width: 100%;
            padding: 12px;
            border: 2px dashed #ccc;
            background: transparent;
            border-radius: 8px;
            color: #666;
            font-size: 14px;
            cursor: pointer;
        }
        
        .add-item-btn:hover {
            border-color: #7B2D8E;
            color: #7B2D8E;
        }
        
        /* Options */
        .options-grid {
            display: grid;
            gap: 12px;
        }
        
        .option-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 10px;
        }
        
        .option-label span:first-child {
            font-weight: 600;
            color: #333;
        }
        
        .option-label span:last-child {
            display: block;
            font-size: 11px;
            color: #888;
            margin-top: 2px;
        }
        
        .option-controls {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .rate-input {
            width: 55px;
            padding: 8px;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            font-size: 14px;
            text-align: center;
            outline: none;
        }
        
        .rate-input:focus {
            border-color: #7B2D8E;
        }
        
        .switch {
            position: relative;
            width: 46px;
            height: 26px;
        }
        
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: 0.3s;
            border-radius: 26px;
        }
        
        .slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
        }
        
        input:checked + .slider {
            background: linear-gradient(135deg, #7B2D8E, #E91E8C);
        }
        
        input:checked + .slider:before {
            transform: translateX(20px);
        }
        
        .discount-input {
            width: 70px;
            padding: 8px;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            font-size: 14px;
            text-align: right;
            outline: none;
        }
        
        .discount-type {
            padding: 8px;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            font-size: 14px;
            outline: none;
            background: white;
        }
        
        /* Summary */
        .bill-summary {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
        }
        
        .summary-row {
            display: flex;
            justify-content: space-between;
            padding: 6px 0;
            font-size: 14px;
            color: #666;
        }
        
        .summary-row.total {
            font-size: 18px;
            font-weight: 700;
            color: #333;
            border-top: 2px solid #ddd;
            padding-top: 12px;
            margin-top: 8px;
        }

        .summary-row.expected-total {
            font-size: 13px;
            color: #666;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px dashed #ddd;
            align-items: center;
        }

        .summary-row.difference-row {
            font-size: 14px;
            font-weight: 600;
            margin-top: 8px;
            padding: 8px 12px;
            border-radius: 8px;
            display: none;
        }

        .summary-row.difference-row.show {
            display: flex;
        }

        .summary-row.difference-row.match {
            background: #d4edda;
            color: #155724;
        }

        .summary-row.difference-row.over {
            background: #fff3cd;
            color: #856404;
        }

        .summary-row.difference-row.under {
            background: #f8d7da;
            color: #721c24;
        }

        .difference-amount {
            font-weight: 700;
        }

        .difference-hint {
            font-size: 11px;
            font-weight: 400;
            opacity: 0.8;
            margin-left: 8px;
        }

        .expected-input-wrap {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .expected-input {
            width: 80px;
            padding: 6px 8px;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            font-size: 14px;
            text-align: right;
            outline: none;
        }

        .expected-input:focus {
            border-color: #7B2D8E;
        }

        .total-match {
            text-align: center;
            padding: 12px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            margin-top: 12px;
            display: none;
        }

        .total-match.match {
            display: block;
            background: #d4edda;
            color: #155724;
            border: 2px solid #28a745;
        }

        .total-match.mismatch {
            display: block;
            background: #f8d7da;
            color: #721c24;
            border: 2px solid #dc3545;
        }

        .total-match .match-icon {
            font-size: 20px;
            display: block;
            margin-bottom: 4px;
        }

        .total-match .match-hint {
            font-size: 11px;
            font-weight: 400;
            opacity: 0.8;
            margin-top: 4px;
        }

        .negative {
            color: #28a745;
        }
        
        /* Person Breakdown */
        .person-breakdown {
            border: 2px solid #e9ecef;
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 12px;
        }
        
        .person-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px 16px;
            background: linear-gradient(135deg, #7B2D8E, #E91E8C);
            color: white;
            cursor: pointer;
        }
        
        .person-name {
            font-weight: 600;
            font-size: 16px;
        }
        
        .person-total {
            font-weight: 700;
            font-size: 18px;
        }
        
        .person-details {
            padding: 12px 16px;
            background: white;
            display: none;
        }
        
        .person-details.show {
            display: block;
        }
        
        .detail-row {
            display: flex;
            justify-content: space-between;
            padding: 4px 0;
            font-size: 13px;
            color: #666;
        }
        
        .detail-row.item {
            color: #333;
        }
        
        .detail-row .shared {
            font-size: 11px;
            color: #888;
        }
        
        .generate-person-btn {
            width: 100%;
            margin-top: 12px;
            padding: 12px;
            background: linear-gradient(135deg, #7B2D8E, #E91E8C);
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
        }
        
        .generate-person-btn:hover {
            opacity: 0.9;
        }
        
        /* QR Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 20px;
        }
        
        .modal-overlay.show {
            display: flex;
        }
        
        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            text-align: center;
            max-width: 350px;
            width: 100%;
        }
        
        .modal-title {
            font-size: 20px;
            font-weight: 700;
            color: #333;
            margin-bottom: 8px;
        }
        
        .modal-subtitle {
            font-size: 14px;
            color: #888;
            margin-bottom: 20px;
        }
        
        .qr-wrapper {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            display: inline-block;
            margin-bottom: 16px;
        }
        
        #qrcode {
            display: flex;
            justify-content: center;
        }
        
        .qr-amount {
            font-size: 32px;
            font-weight: 700;
            color: #7B2D8E;
        }
        
        .qr-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .qr-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
        }
        
        .qr-btn.download {
            background: #28a745;
            color: white;
        }
        
        .qr-btn.close {
            background: #6c757d;
            color: white;
        }
        
        .phone-info {
            font-size: 12px;
            color: #888;
            margin-top: 16px;
        }

        /* Settings Modal Styles */
        .settings-form {
            text-align: left;
            margin-bottom: 20px;
        }

        .settings-group {
            margin-bottom: 16px;
        }

        .settings-label {
            font-weight: 600;
            color: #333;
            font-size: 14px;
            display: block;
            margin-bottom: 4px;
        }

        .settings-help {
            font-size: 12px;
            color: #888;
            margin: 0 0 8px 0;
        }

        .settings-input-row {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .settings-prefix {
            font-weight: 600;
            color: #666;
            font-size: 16px;
        }

        .settings-input {
            flex: 1;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.2s;
        }

        .settings-input:focus {
            outline: none;
            border-color: #7B2D8E;
        }

        .settings-input.error {
            border-color: #dc3545;
        }

        .no-items {
            text-align: center;
            padding: 20px;
            color: #888;
            font-style: italic;
        }

        .shared-items-note {
            font-size: 11px;
            color: #888;
            margin-top: 4px;
            font-style: italic;
        }

        /* Saved Team Section */
        .team-section {
            margin-bottom: 12px;
        }

        .team-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .team-label {
            font-size: 12px;
            color: #666;
            font-weight: 500;
        }

        .team-actions {
            display: flex;
            gap: 8px;
        }

        .team-btn {
            padding: 4px 10px;
            font-size: 11px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            color: #666;
        }

        .team-btn:hover {
            background: #f0f0f0;
        }

        .team-btn.active {
            background: #7B2D8E;
            color: white;
            border-color: #7B2D8E;
        }

        .saved-team-list {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-bottom: 12px;
        }

        .saved-person {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 6px 10px;
            background: #f0f0f0;
            border-radius: 16px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
        }

        .saved-person.selected {
            background: linear-gradient(135deg, #7B2D8E, #E91E8C);
            color: white;
        }

        .saved-person .delete-saved {
            margin-left: 4px;
            opacity: 0.6;
            font-size: 14px;
        }

        .saved-person .delete-saved:hover {
            opacity: 1;
        }

        /* History Section */
        .history-card {
            background: white;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }

        .history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
        }

        .history-item:hover {
            background: #e9ecef;
        }

        .history-info {
            flex: 1;
        }

        .history-date {
            font-size: 12px;
            color: #888;
        }

        .history-desc {
            font-weight: 600;
            color: #333;
        }

        .history-people {
            font-size: 12px;
            color: #666;
        }

        .history-total {
            font-weight: 700;
            color: #7B2D8E;
            font-size: 16px;
        }

        .history-delete {
            margin-left: 12px;
            padding: 6px 10px;
            background: #fee;
            color: #e74c3c;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
        }

        .history-delete:hover {
            background: #e74c3c;
            color: white;
        }

        /* Share Buttons */
        .share-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #eee;
        }

        .share-btn {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .share-btn.whatsapp {
            background: #25D366;
            color: white;
        }

        .share-btn.copy-link {
            background: #6c757d;
            color: white;
        }

        .share-btn.save-history {
            background: #007bff;
            color: white;
        }

        /* Rounding Option */
        .rounding-select {
            padding: 8px;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            font-size: 14px;
            outline: none;
            background: white;
        }

        /* Toast notification */
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            z-index: 2000;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .toast.show {
            opacity: 1;
        }

        /* Tab navigation */
        .tab-nav {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }

        .tab-btn {
            flex: 1;
            padding: 12px;
            border: none;
            background: rgba(255,255,255,0.2);
            color: white;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
        }

        .tab-btn.active {
            background: white;
            color: #7B2D8E;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Receipt Scan Section - Modern Design */
        .ocr-section {
            margin-bottom: 16px;
        }

        .ocr-upload {
            width: 100%;
            padding: 24px 20px;
            border: none;
            border-radius: 16px;
            text-align: center;
            cursor: pointer;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .ocr-upload:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .ocr-upload:active {
            transform: translateY(0);
        }

        .ocr-upload .upload-icon {
            font-size: 32px;
            margin-bottom: 4px;
        }

        .ocr-upload .upload-title {
            font-size: 16px;
            font-weight: 700;
        }

        .ocr-upload .upload-subtitle {
            font-size: 12px;
            opacity: 0.85;
        }

        .ocr-upload .ai-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            background: rgba(255,255,255,0.2);
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 11px;
            margin-top: 4px;
        }

        .ocr-upload input {
            display: none;
        }

        .ocr-status {
            margin-top: 10px;
            padding: 10px;
            background: #e3f2fd;
            border-radius: 6px;
            font-size: 13px;
            color: #1565c0;
            display: none;
        }

        .ocr-status.show {
            display: block;
        }

        .ocr-status.error {
            background: #ffebee;
            color: #c62828;
        }

        /* Payment tracking */
        .person-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px 16px;
            background: linear-gradient(135deg, #7B2D8E, #E91E8C);
            color: white;
            cursor: pointer;
            min-height: 56px;
        }

        .person-header.paid {
            background: linear-gradient(135deg, #1e8449, #27ae60);
        }

        .paid-btn {
            padding: 8px 14px;
            background: rgba(255,255,255,0.2);
            border: 2px solid rgba(255,255,255,0.5);
            color: white;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            margin-left: 10px;
            min-height: 40px;
            transition: all 0.2s;
        }

        .paid-btn:hover, .paid-btn:active {
            background: rgba(255,255,255,0.3);
        }

        .paid-btn.is-paid {
            background: white;
            color: #27ae60;
            border-color: white;
        }

        /* Receipt Preview Modal */
        .preview-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            padding: 20px;
            overflow-y: auto;
        }

        .preview-modal.show {
            display: block;
        }

        .preview-content {
            background: white;
            border-radius: 16px;
            padding: 20px;
            max-width: 500px;
            margin: 20px auto;
        }

        .preview-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .preview-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .preview-item input[type="checkbox"] {
            width: 24px;
            height: 24px;
            cursor: pointer;
        }

        .preview-item-name {
            flex: 1;
            font-size: 15px;
        }

        .preview-item-price {
            font-weight: 600;
            color: #7B2D8E;
        }

        .preview-actions {
            display: flex;
            gap: 10px;
            margin-top: 16px;
        }

        .preview-btn {
            flex: 1;
            padding: 14px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            min-height: 50px;
        }

        .preview-btn.confirm {
            background: linear-gradient(135deg, #7B2D8E, #E91E8C);
            color: white;
        }

        .preview-btn.cancel {
            background: #e9ecef;
            color: #666;
        }

        /* Saved team larger touch targets */
        .saved-person {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 10px 14px;
            background: #f0f0f0;
            border-radius: 20px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
            min-height: 44px;
        }

        .saved-person .delete-saved {
            margin-left: 6px;
            opacity: 0.6;
            font-size: 18px;
            padding: 4px;
            min-width: 28px;
            min-height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Team Code Section */
        .team-code-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 16px;
        }

        .team-code-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .team-code-label {
            font-size: 12px;
            color: #666;
            font-weight: 500;
        }

        .team-code-input-row {
            display: flex;
            gap: 8px;
        }

        .team-code-input {
            flex: 1;
            padding: 10px 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            text-transform: uppercase;
            outline: none;
        }

        .team-code-input:focus {
            border-color: #7B2D8E;
        }

        .team-code-btn {
            padding: 10px 16px;
            background: #7B2D8E;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
        }

        .team-code-btn:hover {
            background: #5a1f6a;
        }

        .team-code-btn.leave {
            background: #e74c3c;
        }

        .team-code-status {
            margin-top: 8px;
            font-size: 12px;
            color: #28a745;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .team-code-status.syncing {
            color: #f39c12;
        }

        .sync-indicator {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            background: #d4edda;
            color: #155724;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
        }

        .sync-indicator.offline {
            background: #f8d7da;
            color: #721c24;
        }

        /* Quick Split Buttons */
        .quick-split-section {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }

        .quick-split-btn {
            flex: 1;
            min-width: 120px;
            padding: 12px 16px;
            border: 2px solid #e9ecef;
            background: white;
            border-radius: 10px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            transition: all 0.2s;
        }

        .quick-split-btn:hover {
            border-color: #7B2D8E;
            background: #f8f4fa;
        }

        .quick-split-btn:active {
            transform: scale(0.98);
        }

        .quick-split-btn .icon {
            font-size: 20px;
        }

        .quick-split-btn .label {
            color: #333;
        }

        .quick-split-btn .desc {
            font-size: 10px;
            color: #888;
            font-weight: 400;
        }

        /* Receipt Preview Section */
        .receipt-preview-section {
            margin-bottom: 16px;
            display: none;
        }

        .receipt-preview-section.show {
            display: block;
        }

        .receipt-preview-card {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 12px;
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .receipt-thumbnail {
            width: 60px;
            height: 80px;
            object-fit: cover;
            border-radius: 8px;
            cursor: pointer;
            border: 2px solid #e9ecef;
        }

        .receipt-thumbnail:hover {
            border-color: #7B2D8E;
        }

        .receipt-info {
            flex: 1;
        }

        .receipt-info .label {
            font-size: 14px;
            font-weight: 600;
            color: #333;
        }

        .receipt-info .meta {
            font-size: 11px;
            color: #888;
            margin-top: 2px;
        }

        .receipt-info .date-badge {
            display: inline-block;
            background: #7B2D8E;
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            margin-top: 6px;
        }

        /* Full Receipt Modal */
        .receipt-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.9);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .receipt-modal.show {
            display: flex;
        }

        .receipt-modal img {
            max-width: 100%;
            max-height: 90vh;
            border-radius: 8px;
        }

        .receipt-modal-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 24px;
            cursor: pointer;
        }

        .receipt-uploading {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #666;
            font-size: 13px;
        }

        .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid #e9ecef;
            border-top-color: #7B2D8E;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Buy Me a Coffee Section */
        .coffee-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid rgba(255,255,255,0.2);
        }

        .coffee-card {
            background: white;
            border-radius: 16px;
            padding: 24px;
            text-align: center;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }

        .coffee-image {
            height: 50px;
            margin-bottom: 12px;
        }

        .coffee-text {
            color: #666;
            font-size: 14px;
            margin: 0 0 16px 0;
        }

        .coffee-qr {
            display: flex;
            justify-content: center;
            background: #f8f9fa;
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 12px;
        }

        .coffee-subtext {
            color: #888;
            font-size: 12px;
            margin: 0;
        }

        /* Undo/Redo Buttons */
        .undo-redo-bar {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }

        .undo-redo-btn {
            flex: 1;
            padding: 10px 16px;
            border: 2px solid #e9ecef;
            background: white;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            transition: all 0.2s;
        }

        .undo-redo-btn:hover:not(:disabled) {
            border-color: #7B2D8E;
            background: #f8f4fa;
        }

        .undo-redo-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .undo-redo-btn .icon {
            font-size: 16px;
        }

        .undo-redo-btn .shortcut {
            font-size: 10px;
            color: #888;
            margin-left: 4px;
        }

        /* Syncing Indicator */
        .sync-toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.85);
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            font-size: 13px;
            font-weight: 500;
            z-index: 3000;
            display: flex;
            align-items: center;
            gap: 8px;
            opacity: 0;
            transition: opacity 0.3s, transform 0.3s;
            pointer-events: none;
        }

        .sync-toast.show {
            opacity: 1;
        }

        .sync-toast.syncing {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .sync-toast.receiving {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .sync-toast.synced {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        }

        .sync-toast.offline {
            background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%);
        }

        .sync-spinner {
            width: 14px;
            height: 14px;
            border: 2px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        .sync-icon {
            font-size: 14px;
        }

        /* Live indicator dot */
        .live-indicator {
            position: absolute;
            top: 8px;
            left: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
            background: rgba(255,255,255,0.2);
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 11px;
            color: white;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .live-indicator.show {
            opacity: 1;
        }

        .live-dot {
            width: 8px;
            height: 8px;
            background: #4ade80;
            border-radius: 50%;
            animation: pulse 2s ease-in-out infinite;
        }

        .live-dot.active {
            background: #fbbf24;
            animation: pulse 0.5s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(0.8); }
        }

        /* Sub-tabs Navigation */
        .sub-tab-nav {
            display: flex;
            gap: 4px;
            background: #f1f3f4;
            padding: 4px;
            border-radius: 12px;
            margin-bottom: 16px;
        }

        .sub-tab-btn {
            flex: 1;
            padding: 10px 8px;
            border: none;
            background: transparent;
            border-radius: 10px;
            font-size: 13px;
            font-weight: 600;
            color: #666;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
        }

        .sub-tab-btn .tab-icon {
            font-size: 18px;
        }

        .sub-tab-btn .tab-label {
            font-size: 11px;
        }

        .sub-tab-btn:hover {
            color: #7B2D8E;
            background: rgba(123, 45, 142, 0.1);
        }

        .sub-tab-btn.active {
            background: white;
            color: #7B2D8E;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .sub-tab-content {
            display: none;
        }

        .sub-tab-content.active {
            display: block;
            animation: fadeIn 0.2s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Badge for sub-tabs */
        .sub-tab-badge {
            background: #7B2D8E;
            color: white;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 10px;
            margin-left: 4px;
        }
    </style>
</head>
<body>
    <!-- Sync Indicator Toast -->
    <div class="sync-toast" id="syncToast">
        <div class="sync-spinner" id="syncSpinner"></div>
        <span class="sync-icon" id="syncIcon" style="display:none;"></span>
        <span id="syncMessage">Syncing...</span>
    </div>

    <div class="app-container">
        <div class="header">
            <h1>üçú PayNow Splitter</h1>
            <p>Each person pays for their own items</p>
            <button class="settings-btn" onclick="openSettings()" title="Settings">‚öôÔ∏è</button>
        </div>

        <!-- Tab Navigation -->
        <div class="tab-nav">
            <button class="tab-btn active" onclick="switchTab('split')">üßæ Split Bill</button>
            <button class="tab-btn" onclick="switchTab('history')">üìã History</button>
        </div>

        <!-- Split Bill Tab -->
        <div class="tab-content active" id="tab-split">

        <!-- Sub-tab Navigation -->
        <div class="sub-tab-nav">
            <button class="sub-tab-btn active" onclick="switchSubTab('people')">
                <span class="tab-icon">üë•</span>
                <span class="tab-label">People</span>
            </button>
            <button class="sub-tab-btn" onclick="switchSubTab('items')">
                <span class="tab-icon">üçΩÔ∏è</span>
                <span class="tab-label">Items</span>
            </button>
            <button class="sub-tab-btn" onclick="switchSubTab('summary')">
                <span class="tab-icon">üí∞</span>
                <span class="tab-label">Summary</span>
            </button>
        </div>

        <!-- Sub-tab: People -->
        <div class="sub-tab-content active" id="subtab-people">

        <!-- Team Code -->
        <div class="card">
            <div class="card-title"><span class="icon">üîó</span> Team Sync</div>
            <div class="team-code-section" id="teamCodeSection">
                <div class="team-code-header">
                    <span class="team-code-label">Enter a team code to sync with your teammates</span>
                </div>
                <div class="team-code-input-row" id="teamCodeInputRow">
                    <input type="text" class="team-code-input" id="teamCodeInput" placeholder="e.g., LUNCH2024" maxlength="20">
                    <button class="team-code-btn" onclick="joinTeam()">Join</button>
                </div>
                <div class="team-code-status" id="teamCodeStatus" style="display: none;"></div>
            </div>
        </div>

        <!-- People -->
        <div class="card">
            <div class="card-title"><span class="icon">üë•</span> Who's Eating?</div>

            <!-- Saved Team -->
            <div class="team-section" id="teamSection">
                <div class="team-header">
                    <span class="team-label">Your Team (click to add)</span>
                    <div class="team-actions">
                        <button class="team-btn" onclick="selectAllTeam()">All</button>
                        <button class="team-btn" onclick="selectNoneTeam()">None</button>
                    </div>
                </div>
                <div class="saved-team-list" id="savedTeamList"></div>
            </div>

            <div class="people-list" id="peopleList"></div>
            <div class="add-person-row">
                <input type="text" class="add-person-input" id="newPersonName" placeholder="Enter name (saves to team)" onkeypress="if(event.key==='Enter')addPerson()">
                <button class="add-btn" onclick="addPerson()">+ Add</button>
            </div>
        </div>

        </div><!-- End Sub-tab: People -->

        <!-- Sub-tab: Items -->
        <div class="sub-tab-content" id="subtab-items">

        <!-- Items -->
        <div class="card">
            <div class="card-title"><span class="icon">üçΩÔ∏è</span> What's Ordered?</div>

            <!-- Receipt Preview (shared with team) -->
            <div class="receipt-preview-section" id="receiptPreviewSection">
                <div class="receipt-preview-card">
                    <img class="receipt-thumbnail" id="receiptThumbnail" src="" alt="Receipt" onclick="showReceiptModal()">
                    <div class="receipt-info">
                        <div class="label">üì∑ Today's Receipt</div>
                        <div class="meta" id="receiptMeta">Uploaded just now</div>
                        <div class="date-badge" id="receiptDate"></div>
                    </div>
                </div>
            </div>

            <!-- Undo/Redo Buttons -->
            <div class="undo-redo-bar">
                <button class="undo-redo-btn" id="undoBtn" onclick="undo()" disabled style="opacity: 0.5;">
                    <span class="icon">‚Ü©Ô∏è</span>
                    <span>Undo</span>
                    <span class="shortcut">(Ctrl+Z)</span>
                </button>
                <button class="undo-redo-btn" id="redoBtn" onclick="redo()" disabled style="opacity: 0.5;">
                    <span class="icon">‚Ü™Ô∏è</span>
                    <span>Redo</span>
                    <span class="shortcut">(Ctrl+Y)</span>
                </button>
            </div>

            <!-- Quick Split Buttons -->
            <div class="quick-split-section" id="quickSplitSection">
                <button class="quick-split-btn" onclick="splitAllEqually()">
                    <span class="icon">üë•</span>
                    <span class="label">Split Equally</span>
                    <span class="desc">Everyone shares all</span>
                </button>
                <button class="quick-split-btn" onclick="splitEachOwn()">
                    <span class="icon">üôã</span>
                    <span class="label">Each Own</span>
                    <span class="desc">Assign per person</span>
                </button>
                <button class="quick-split-btn" onclick="clearAllAssignments()">
                    <span class="icon">üîÑ</span>
                    <span class="label">Clear All</span>
                    <span class="desc">Reset assignments</span>
                </button>
                <button class="quick-split-btn" onclick="startNewSession()">
                    <span class="icon">‚ú®</span>
                    <span class="label">New Session</span>
                    <span class="desc">Start fresh bill</span>
                </button>
            </div>

            <!-- AI Receipt Scanner -->
            <div class="ocr-section">
                <label class="ocr-upload" id="ocrUpload">
                    <input type="file" accept="image/*" onchange="handleReceiptUpload(event)">
                    <span class="upload-icon">üì∏</span>
                    <span class="upload-title">Scan Receipt with AI</span>
                    <span class="upload-subtitle">Take a photo or upload an image</span>
                    <span class="ai-badge">‚ú® Powered by AI</span>
                </label>
                <div class="ocr-status" id="ocrStatus"></div>
            </div>

            <div id="itemsList"></div>
            <button class="add-item-btn" onclick="addItem()">+ Add Item</button>
        </div>

        </div><!-- End Sub-tab: Items -->

        <!-- Sub-tab: Summary -->
        <div class="sub-tab-content" id="subtab-summary">

        <!-- Options -->
        <div class="card">
            <div class="card-title"><span class="icon">‚öôÔ∏è</span> Bill Options</div>
            <div class="options-grid">
                <div class="option-row">
                    <div class="option-label">
                        <span>Service Charge</span>
                        <span>Before GST</span>
                    </div>
                    <div class="option-controls">
                        <input type="number" class="rate-input" id="serviceRate" value="10" min="0" max="100" step="0.5" oninput="calculate(); saveBillOptions(); syncSessionToFirebase();">
                        <span>%</span>
                        <label class="switch">
                            <input type="checkbox" id="hasService" onchange="calculate(); saveBillOptions(); syncSessionToFirebase();">
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>

                <div class="option-row">
                    <div class="option-label">
                        <span>Discount</span>
                        <span>Before GST</span>
                    </div>
                    <div class="option-controls">
                        <input type="number" class="discount-input" id="discountValue" placeholder="0" step="0.01" oninput="calculate(); saveBillOptions(); syncSessionToFirebase();">
                        <select class="discount-type" id="discountType" onchange="calculate(); saveBillOptions(); syncSessionToFirebase();">
                            <option value="amount">S$</option>
                            <option value="percent">%</option>
                        </select>
                    </div>
                </div>

                <div class="option-row">
                    <div class="option-label">
                        <span>GST</span>
                        <span>After svc & discount</span>
                    </div>
                    <div class="option-controls">
                        <input type="number" class="rate-input" id="gstRate" value="9" min="0" max="100" step="0.5" oninput="calculate(); saveBillOptions(); syncSessionToFirebase();">
                        <span>%</span>
                        <label class="switch">
                            <input type="checkbox" id="hasGST" checked onchange="calculate(); saveBillOptions(); syncSessionToFirebase();">
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>

                <div class="option-row">
                    <div class="option-label">
                        <span>Rounding</span>
                        <span>Per person amount</span>
                    </div>
                    <div class="option-controls">
                        <select class="rounding-select" id="roundingType" onchange="calculate(); saveBillOptions(); syncSessionToFirebase();">
                            <option value="none">Exact</option>
                            <option value="0.10">$0.10</option>
                            <option value="0.50">$0.50</option>
                            <option value="1.00">$1.00</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Summary -->
        <div class="card">
            <div class="card-title"><span class="icon">üßæ</span> Bill Summary</div>
            <div class="bill-summary">
                <div class="summary-row">
                    <span>Subtotal</span>
                    <span id="subtotalDisplay">S$ 0.00</span>
                </div>
                <div class="summary-row" id="discountRow" style="display: none;">
                    <span>Discount</span>
                    <span class="negative" id="discountDisplay">-S$ 0.00</span>
                </div>
                <div class="summary-row" id="subtotalAfterDiscountRow" style="display: none;">
                    <span>After Discount</span>
                    <span id="subtotalAfterDiscountDisplay">S$ 0.00</span>
                </div>
                <div class="summary-row" id="serviceRow" style="display: none;">
                    <span>Service (<span id="svcPct">10</span>%)</span>
                    <span id="serviceDisplay">S$ 0.00</span>
                </div>
                <div class="summary-row" id="gstRow">
                    <span>GST (<span id="gstPct">9</span>%)</span>
                    <span id="gstDisplay">S$ 0.00</span>
                </div>
                <div class="summary-row total">
                    <span>Total</span>
                    <span id="totalDisplay">S$ 0.00</span>
                </div>
                <div class="summary-row expected-total">
                    <span>Expected Total (from receipt)</span>
                    <div class="expected-input-wrap">
                        <span>S$</span>
                        <input type="number" class="expected-input" id="expectedTotal" placeholder="0.00" step="0.01" oninput="checkTotalMatch(); syncSessionToFirebase();">
                    </div>
                </div>
                <div class="summary-row difference-row" id="differenceRow">
                    <span id="differenceLabel">Difference</span>
                    <span class="difference-amount" id="differenceAmount">S$ 0.00</span>
                </div>
                <div class="total-match" id="totalMatch"></div>
            </div>
            
            <div class="card-title"><span class="icon">üí∞</span> Each Person Pays</div>
            <div id="breakdownList">
                <div class="no-items">Add people and items to see breakdown</div>
            </div>

            <!-- Share Actions -->
            <div class="share-actions" id="shareActions" style="display: none;">
                <button class="share-btn whatsapp" onclick="shareWhatsApp()">üì± WhatsApp</button>
                <button class="share-btn seatalk" id="seatalkBtn" onclick="sendToSeatalk()" style="display: none; background: linear-gradient(135deg, #00a9e0, #0077b5);">üí¨ Seatalk</button>
                <button class="share-btn copy-link" onclick="copyShareLink()">üîó Copy Link</button>
                <button class="share-btn save-history" onclick="saveToHistory()">üíæ Save</button>
            </div>
        </div>

        </div><!-- End Sub-tab: Summary -->

        </div><!-- End Split Tab -->

        <!-- History Tab -->
        <div class="tab-content" id="tab-history">
            <div class="card">
                <div class="card-title"><span class="icon">üìã</span> Split History</div>
                <div id="historyList">
                    <div class="no-items">No saved splits yet</div>
                </div>
                <button class="add-item-btn" onclick="clearHistory()" style="margin-top: 12px; border-color: #e74c3c; color: #e74c3c;">üóëÔ∏è Clear All History</button>
            </div>
        </div>

        <!-- Buy Me a Coffee -->
        <div class="coffee-section">
            <div class="coffee-card">
                <img src="https://cdn.buymeacoffee.com/buttons/v2/default-yellow.png" alt="Buy Me A Coffee" class="coffee-image">
                <p class="coffee-text">If you find this app useful, buy me a coffee!</p>
                <div class="coffee-qr" id="coffeeQrCode"></div>
                <p class="coffee-subtext">Scan to PayNow S$3.00</p>
            </div>
        </div>

    </div>
    
    <!-- QR Modal -->
    <div class="modal-overlay" id="qrModal" onclick="closeModal(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-title" id="modalName">Person Name</div>
            <div class="modal-subtitle">Scan to pay your share</div>
            <div class="qr-wrapper">
                <div id="qrcode"></div>
            </div>
            <div class="qr-amount" id="modalAmount">S$ 0.00</div>
            <div class="qr-actions">
                <button class="qr-btn download" onclick="downloadQR()">üì• Download</button>
                <button class="qr-btn close" onclick="closeModal()">‚úï Close</button>
            </div>
            <div class="phone-info">PayNow to +65 8339 9525</div>
        </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <!-- Settings Modal -->
    <div class="modal-overlay" id="settingsModal" onclick="closeSettings(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-title">‚öôÔ∏è Settings</div>
            <div class="settings-form">
                <div class="settings-group">
                    <label class="settings-label">PayNow Phone Number</label>
                    <p class="settings-help">Enter your Singapore phone number (8 digits)</p>
                    <div class="settings-input-row">
                        <span class="settings-prefix">+65</span>
                        <input type="tel" class="settings-input" id="paynowNumberInput" placeholder="8XXXXXXX" maxlength="8" pattern="[89][0-9]{7}">
                    </div>
                </div>
            </div>
            <div class="qr-actions">
                <button class="qr-btn download" onclick="saveSettings()">üíæ Save</button>
                <button class="qr-btn close" onclick="closeSettings()">‚úï Cancel</button>
            </div>
        </div>
    </div>

    <!-- Receipt Full View Modal -->
    <div class="receipt-modal" id="receiptModal" onclick="closeReceiptModal()">
        <button class="receipt-modal-close" onclick="closeReceiptModal()">√ó</button>
        <img id="receiptFullImage" src="" alt="Receipt">
    </div>

    <!-- Receipt Preview Modal -->
    <div class="preview-modal" id="previewModal">
        <div class="preview-content">
            <div class="preview-title">
                <span>üì∑ Scanned Items</span>
                <span id="previewCount">0 items</span>
            </div>
            <div id="previewItems"></div>
            <div class="preview-actions">
                <button class="preview-btn cancel" onclick="closePreview()">Cancel</button>
                <button class="preview-btn confirm" onclick="confirmPreview()">Add Selected</button>
            </div>
        </div>
    </div>

    <script>
        let people = [];
        let items = [];
        let itemIdCounter = 0;
        let qrcode = null;
        let savedTeam = [];
        let splitHistory = [];
        let paidStatus = {}; // Track who has paid
        let pendingOcrItems = []; // Items pending from receipt scan

        // LocalStorage keys
        const TEAM_KEY = 'paynow_team';
        const HISTORY_KEY = 'paynow_history';
        const TEAM_CODE_KEY = 'paynow_team_code';
        const PAYNOW_NUMBER_KEY = 'paynow_number';
        const BILL_OPTIONS_KEY = 'paynow_bill_options';

        // Default PayNow number
        const DEFAULT_PAYNOW_NUMBER = '+6583399525';

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyA8bj45ygxLjMiWH-iNdqzNJeXmU_mG5dY",
            authDomain: "paysplitter-16bd6.firebaseapp.com",
            projectId: "paysplitter-16bd6",
            storageBucket: "paysplitter-16bd6.firebasestorage.app",
            messagingSenderId: "906740214966",
            appId: "1:906740214966:web:139c8b63ee599484474a17"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const storage = firebase.storage();

        // Current receipt image URL (shared with team)
        let currentReceiptUrl = null;

        // Team code for syncing
        let currentTeamCode = null;
        let unsubscribeTeam = null;
        let unsubscribeHistory = null;

        // Flag to prevent sync loops when receiving Firebase updates
        let isReceivingUpdate = false;

        // Current session ID (for one-receipt-one-history feature)
        let currentSessionId = null;

        // Seatalk integration - chat ID from URL for sending results back
        let seatalkChatId = null;
        const N8N_SEATALK_WEBHOOK_URL = 'https://shortly-curious-donkey.ngrok-free.app/webhook/zvHPJ0e13zrf4Cjx/webhook/paysplitter-results';

        // Undo/Redo stacks
        let undoStack = [];
        let redoStack = [];
        const MAX_UNDO_HISTORY = 50;
        let isUndoingOrRedoing = false;

        // Save current state for undo
        function saveStateForUndo() {
            if (isUndoingOrRedoing || isReceivingUpdate) return;

            const state = {
                people: JSON.parse(JSON.stringify(people)),
                items: JSON.parse(JSON.stringify(items)),
                paidStatus: JSON.parse(JSON.stringify(paidStatus)),
                itemIdCounter: itemIdCounter,
                billOptions: {
                    hasService: document.getElementById('hasService')?.checked || false,
                    serviceRate: parseFloat(document.getElementById('serviceRate')?.value) || 10,
                    hasGST: document.getElementById('hasGST')?.checked !== false,
                    gstRate: parseFloat(document.getElementById('gstRate')?.value) || 9,
                    discountValue: parseFloat(document.getElementById('discountValue')?.value) || 0,
                    discountType: document.getElementById('discountType')?.value || 'amount',
                    roundingType: document.getElementById('roundingType')?.value || 'none',
                    expectedTotal: parseFloat(document.getElementById('expectedTotal')?.value) || 0
                }
            };

            undoStack.push(state);
            if (undoStack.length > MAX_UNDO_HISTORY) {
                undoStack.shift(); // Remove oldest state
            }

            // Clear redo stack when new action is performed
            redoStack = [];

            updateUndoRedoButtons();
        }

        // Undo last action
        function undo() {
            if (undoStack.length === 0) {
                showToast('Nothing to undo');
                return;
            }

            isUndoingOrRedoing = true;

            // Save current state to redo stack
            const currentState = {
                people: JSON.parse(JSON.stringify(people)),
                items: JSON.parse(JSON.stringify(items)),
                paidStatus: JSON.parse(JSON.stringify(paidStatus)),
                itemIdCounter: itemIdCounter,
                billOptions: {
                    hasService: document.getElementById('hasService').checked,
                    serviceRate: parseFloat(document.getElementById('serviceRate').value) || 10,
                    hasGST: document.getElementById('hasGST').checked,
                    gstRate: parseFloat(document.getElementById('gstRate').value) || 9,
                    discountValue: parseFloat(document.getElementById('discountValue').value) || 0,
                    discountType: document.getElementById('discountType').value,
                    roundingType: document.getElementById('roundingType').value,
                    expectedTotal: parseFloat(document.getElementById('expectedTotal').value) || 0
                }
            };
            redoStack.push(currentState);

            // Restore previous state
            const previousState = undoStack.pop();
            restoreState(previousState);

            isUndoingOrRedoing = false;
            syncSessionToFirebase();
            showToast('Undone');
        }

        // Redo last undone action
        function redo() {
            if (redoStack.length === 0) {
                showToast('Nothing to redo');
                return;
            }

            isUndoingOrRedoing = true;

            // Save current state to undo stack
            const currentState = {
                people: JSON.parse(JSON.stringify(people)),
                items: JSON.parse(JSON.stringify(items)),
                paidStatus: JSON.parse(JSON.stringify(paidStatus)),
                itemIdCounter: itemIdCounter,
                billOptions: {
                    hasService: document.getElementById('hasService').checked,
                    serviceRate: parseFloat(document.getElementById('serviceRate').value) || 10,
                    hasGST: document.getElementById('hasGST').checked,
                    gstRate: parseFloat(document.getElementById('gstRate').value) || 9,
                    discountValue: parseFloat(document.getElementById('discountValue').value) || 0,
                    discountType: document.getElementById('discountType').value,
                    roundingType: document.getElementById('roundingType').value,
                    expectedTotal: parseFloat(document.getElementById('expectedTotal').value) || 0
                }
            };
            undoStack.push(currentState);

            // Restore redo state
            const redoState = redoStack.pop();
            restoreState(redoState);

            isUndoingOrRedoing = false;
            syncSessionToFirebase();
            showToast('Redone');
        }

        // Restore a saved state
        function restoreState(state) {
            people = state.people;
            items = state.items;
            paidStatus = state.paidStatus;
            itemIdCounter = state.itemIdCounter;

            // Restore bill options
            if (state.billOptions) {
                document.getElementById('hasService').checked = state.billOptions.hasService;
                document.getElementById('serviceRate').value = state.billOptions.serviceRate;
                document.getElementById('hasGST').checked = state.billOptions.hasGST;
                document.getElementById('gstRate').value = state.billOptions.gstRate;
                document.getElementById('discountValue').value = state.billOptions.discountValue || '';
                document.getElementById('discountType').value = state.billOptions.discountType;
                document.getElementById('roundingType').value = state.billOptions.roundingType;
                document.getElementById('expectedTotal').value = state.billOptions.expectedTotal || '';
            }

            renderPeople();
            renderItems();
            renderSavedTeam();
            calculate();
            updateUndoRedoButtons();
        }

        // Update undo/redo button states
        function updateUndoRedoButtons() {
            const undoBtn = document.getElementById('undoBtn');
            const redoBtn = document.getElementById('redoBtn');
            if (undoBtn) {
                undoBtn.disabled = undoStack.length === 0;
                undoBtn.style.opacity = undoStack.length === 0 ? '0.5' : '1';
            }
            if (redoBtn) {
                redoBtn.disabled = redoStack.length === 0;
                redoBtn.style.opacity = redoStack.length === 0 ? '0.5' : '1';
            }
        }

        // ==================== SYNC INDICATOR ====================

        let syncToastTimeout = null;

        // Show sync indicator
        function showSyncIndicator(type, message) {
            const toast = document.getElementById('syncToast');
            const spinner = document.getElementById('syncSpinner');
            const icon = document.getElementById('syncIcon');
            const msg = document.getElementById('syncMessage');

            if (!toast) return;

            // Clear any pending hide timeout
            if (syncToastTimeout) {
                clearTimeout(syncToastTimeout);
                syncToastTimeout = null;
            }

            // Reset classes
            toast.className = 'sync-toast';

            // Set message
            msg.textContent = message;

            // Configure based on type
            switch(type) {
                case 'syncing':
                    toast.classList.add('syncing');
                    spinner.style.display = 'block';
                    icon.style.display = 'none';
                    break;
                case 'receiving':
                    toast.classList.add('receiving');
                    spinner.style.display = 'block';
                    icon.style.display = 'none';
                    break;
                case 'synced':
                    toast.classList.add('synced');
                    spinner.style.display = 'none';
                    icon.style.display = 'inline';
                    icon.textContent = '‚úì';
                    break;
                case 'offline':
                    toast.classList.add('offline');
                    spinner.style.display = 'none';
                    icon.style.display = 'inline';
                    icon.textContent = '‚ö†';
                    break;
            }

            // Show toast
            toast.classList.add('show');
        }

        // Hide sync indicator (with optional delay)
        function hideSyncIndicator(delay = 0) {
            if (delay > 0) {
                syncToastTimeout = setTimeout(() => {
                    const toast = document.getElementById('syncToast');
                    if (toast) toast.classList.remove('show');
                }, delay);
            } else {
                const toast = document.getElementById('syncToast');
                if (toast) toast.classList.remove('show');
            }
        }

        // Initialize
        function init() {
            loadSavedTeam();
            loadHistory();
            loadTeamCode();
            loadBillOptions(); // Load saved bill options (service charge, GST, etc.)
            checkUrlParams();
            if (people.length === 0) {
                addItem();
            }
            renderSavedTeam();
            renderHistory();
            renderTeamCodeUI();
            updatePayNowDisplay();
            generateCoffeeQR();
            setupKeyboardShortcuts();
            calculate(); // Recalculate with loaded options
        }

        // Setup keyboard shortcuts for undo/redo
        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', function(e) {
                // Check if user is typing in an input field
                const isInputFocused = document.activeElement.tagName === 'INPUT' ||
                                       document.activeElement.tagName === 'TEXTAREA' ||
                                       document.activeElement.tagName === 'SELECT';

                // Ctrl+Z or Cmd+Z for Undo
                if ((e.ctrlKey || e.metaKey) && e.key === 'z' && !e.shiftKey) {
                    if (!isInputFocused) {
                        e.preventDefault();
                        undo();
                    }
                }

                // Ctrl+Y or Cmd+Y or Ctrl+Shift+Z for Redo
                if ((e.ctrlKey || e.metaKey) && (e.key === 'y' || (e.key === 'z' && e.shiftKey))) {
                    if (!isInputFocused) {
                        e.preventDefault();
                        redo();
                    }
                }
            });
        }

        // Generate Buy Me a Coffee QR code
        function generateCoffeeQR() {
            const coffeeAmount = 3.00; // S$3.00 for a coffee
            const coffeePayNowString = generateCoffeePayNowString(coffeeAmount);
            const coffeeQrDiv = document.getElementById('coffeeQrCode');

            new QRCode(coffeeQrDiv, {
                text: coffeePayNowString,
                width: 120,
                height: 120,
                colorDark: '#000000',
                colorLight: '#ffffff',
                correctLevel: QRCode.CorrectLevel.H  // High error correction for logo overlay
            });

            // Add PayNow logo (smaller for coffee QR)
            addLogoToQR(coffeeQrDiv, 30);
        }

        // Generate PayNow string for coffee (always uses developer's number)
        function generateCoffeePayNowString(amount) {
            let merchantAcctInfo = '';
            merchantAcctInfo += tlv('00', 'SG.PAYNOW');
            merchantAcctInfo += tlv('01', '0');
            merchantAcctInfo += tlv('02', '+6583399525'); // Developer's PayNow number
            merchantAcctInfo += tlv('03', '1');

            let payload = '';
            payload += tlv('00', '01');
            payload += tlv('01', '12');
            payload += tlv('26', merchantAcctInfo);
            payload += tlv('52', '0000');
            payload += tlv('53', '702');
            payload += tlv('54', amount.toFixed(2));
            payload += tlv('58', 'SG');
            payload += tlv('59', 'NA');
            payload += tlv('60', 'Singapore');
            payload += tlv('62', tlv('05', 'Coffee'));

            payload += '6304';
            const checksum = calculateCRC(payload);
            return payload + checksum;
        }

        // Load team code from localStorage and connect
        function loadTeamCode() {
            const savedCode = localStorage.getItem(TEAM_CODE_KEY);
            if (savedCode) {
                currentTeamCode = savedCode;
                connectToTeam(savedCode);
            }
        }

        // Join a team by code
        async function joinTeam() {
            const input = document.getElementById('teamCodeInput');
            const code = input.value.trim().toUpperCase();

            if (!code || code.length < 3) {
                showToast('Please enter a valid team code (min 3 characters)');
                return;
            }

            try {
                // Save to localStorage
                localStorage.setItem(TEAM_CODE_KEY, code);
                currentTeamCode = code;

                // Create team doc if doesn't exist
                const teamRef = db.collection('teams').doc(code);
                const teamDoc = await teamRef.get();

                if (!teamDoc.exists) {
                    // Create new team with current data
                    await teamRef.set({
                        teammates: savedTeam,
                        history: splitHistory,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    showToast(`Created team: ${code}`);
                } else {
                    showToast(`Joined team: ${code}`);
                }

                // Connect to real-time updates
                connectToTeam(code);
                renderTeamCodeUI();

            } catch (e) {
                console.error('Error joining team:', e);
                showToast('Error connecting to team');
            }
        }

        // Leave current team
        function leaveTeam() {
            if (unsubscribeTeam) unsubscribeTeam();
            if (unsubscribeHistory) unsubscribeHistory();

            localStorage.removeItem(TEAM_CODE_KEY);
            currentTeamCode = null;

            renderTeamCodeUI();
            showToast('Left team - now using local storage only');
        }

        // Connect to team for real-time updates
        function connectToTeam(code) {
            // Unsubscribe from previous listeners
            if (unsubscribeTeam) unsubscribeTeam();
            if (unsubscribeHistory) unsubscribeHistory();

            const teamRef = db.collection('teams').doc(code);

            // Listen for all team data changes (including current session)
            unsubscribeTeam = teamRef.onSnapshot((doc) => {
                if (doc.exists) {
                    const data = doc.data();
                    if (data.teammates) {
                        savedTeam = data.teammates;
                        localStorage.setItem(TEAM_KEY, JSON.stringify(savedTeam));
                        renderSavedTeam();
                    }
                    if (data.history) {
                        splitHistory = data.history;
                        localStorage.setItem(HISTORY_KEY, JSON.stringify(splitHistory));
                        renderHistory();
                    }
                    // Check for shared receipt
                    if (data.receiptUrl) {
                        currentReceiptUrl = data.receiptUrl;
                        showReceiptPreview(data.receiptUrl, data.receiptDate, data.receiptUploader);
                    } else {
                        hideReceiptPreview();
                    }
                    // Real-time session sync - load current session from other team members
                    if (data.currentSession && !isReceivingUpdate) {
                        loadSessionFromFirebase(data.currentSession);
                    }
                    updateSyncStatus('synced');
                }
            }, (error) => {
                console.error('Firestore error:', error);
                updateSyncStatus('offline');
                showSyncIndicator('offline', 'Connection lost');
                hideSyncIndicator(3000);
            });
        }

        // Update sync status indicator
        function updateSyncStatus(status) {
            const statusEl = document.getElementById('teamCodeStatus');
            if (status === 'synced') {
                statusEl.innerHTML = '<span class="sync-indicator">‚úì Synced</span> Team data is shared with teammates';
            } else if (status === 'offline') {
                statusEl.innerHTML = '<span class="sync-indicator offline">‚ö† Offline</span> Using local data';
            }
        }

        // Render team code UI based on connection state
        function renderTeamCodeUI() {
            const inputRow = document.getElementById('teamCodeInputRow');
            const status = document.getElementById('teamCodeStatus');
            const label = document.querySelector('.team-code-label');

            if (currentTeamCode) {
                inputRow.innerHTML = `
                    <span style="flex:1; font-weight: 600; color: #7B2D8E; font-size: 16px;">üì° ${currentTeamCode}</span>
                    <button class="team-code-btn leave" onclick="leaveTeam()">Leave</button>
                `;
                label.textContent = 'Connected to team:';
                status.style.display = 'flex';
            } else {
                inputRow.innerHTML = `
                    <input type="text" class="team-code-input" id="teamCodeInput" placeholder="e.g., LUNCH2024" maxlength="20">
                    <button class="team-code-btn" onclick="joinTeam()">Join</button>
                `;
                label.textContent = 'Enter a team code to sync with your teammates';
                status.style.display = 'none';
            }
        }

        // Override saveTeam to sync to Firebase
        async function saveTeamToFirebase() {
            if (!currentTeamCode) return;

            try {
                await db.collection('teams').doc(currentTeamCode).update({
                    teammates: savedTeam
                });
            } catch (e) {
                console.error('Error saving team to Firebase:', e);
            }
        }

        // Override saveHistory to sync to Firebase
        async function saveHistoryToFirebase() {
            if (!currentTeamCode) return;

            try {
                await db.collection('teams').doc(currentTeamCode).update({
                    history: splitHistory
                });
            } catch (e) {
                console.error('Error saving history to Firebase:', e);
            }
        }

        // Sync current session to Firebase (real-time collaboration)
        let syncTimeout = null;
        async function syncSessionToFirebase() {
            if (!currentTeamCode || isReceivingUpdate) return;

            // Debounce: wait 300ms before syncing to avoid too many writes
            if (syncTimeout) clearTimeout(syncTimeout);
            syncTimeout = setTimeout(async () => {
                try {
                    // Show syncing indicator
                    showSyncIndicator('syncing', 'Saving changes...');

                    // Generate session ID if not exists (based on today's date)
                    if (!currentSessionId) {
                        currentSessionId = new Date().toISOString().split('T')[0] + '_' + Date.now();
                    }

                    const billOptions = {
                        hasService: document.getElementById('hasService').checked,
                        serviceRate: parseFloat(document.getElementById('serviceRate').value) || 10,
                        hasGST: document.getElementById('hasGST').checked,
                        gstRate: parseFloat(document.getElementById('gstRate').value) || 9,
                        discountValue: parseFloat(document.getElementById('discountValue').value) || 0,
                        discountType: document.getElementById('discountType').value,
                        roundingType: document.getElementById('roundingType').value,
                        expectedTotal: parseFloat(document.getElementById('expectedTotal').value) || 0
                    };

                    await db.collection('teams').doc(currentTeamCode).update({
                        currentSession: {
                            sessionId: currentSessionId,
                            people: people,
                            items: items,
                            paidStatus: paidStatus,
                            billOptions: billOptions,
                            lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                        }
                    });
                    console.log('Session synced to Firebase');

                    // Show synced indicator briefly
                    showSyncIndicator('synced', 'Saved');
                    hideSyncIndicator(1500);
                } catch (e) {
                    console.error('Error syncing session to Firebase:', e);
                    showSyncIndicator('offline', 'Sync failed');
                    hideSyncIndicator(2000);
                }
            }, 300);
        }

        // Load session from Firebase data
        function loadSessionFromFirebase(sessionData) {
            if (!sessionData) return;

            isReceivingUpdate = true;

            // Show receiving indicator
            showSyncIndicator('receiving', 'Teammate updating...');

            // Update session ID
            currentSessionId = sessionData.sessionId || null;

            // Update people
            if (sessionData.people) {
                people = sessionData.people;
                renderPeople();
                renderSavedTeam();
            }

            // Update items
            if (sessionData.items) {
                items = sessionData.items;
                itemIdCounter = Math.max(...items.map(i => i.id), 0) + 1;
                renderItems();
            }

            // Update paid status
            if (sessionData.paidStatus) {
                paidStatus = sessionData.paidStatus;
            }

            // Update bill options
            if (sessionData.billOptions) {
                const opts = sessionData.billOptions;
                document.getElementById('hasService').checked = opts.hasService || false;
                document.getElementById('serviceRate').value = opts.serviceRate || 10;
                document.getElementById('hasGST').checked = opts.hasGST !== false;
                document.getElementById('gstRate').value = opts.gstRate || 9;
                document.getElementById('discountValue').value = opts.discountValue || '';
                document.getElementById('discountType').value = opts.discountType || 'amount';
                document.getElementById('roundingType').value = opts.roundingType || 'none';
                if (opts.expectedTotal > 0) {
                    document.getElementById('expectedTotal').value = opts.expectedTotal;
                }
                saveBillOptions(); // Save synced options to localStorage
            }

            calculate();

            // Show synced and hide after delay
            showSyncIndicator('synced', 'Updated');
            hideSyncIndicator(1500);

            // Reset flag after a short delay
            setTimeout(() => { isReceivingUpdate = false; }, 100);
        }

        // Load saved team from localStorage
        function loadSavedTeam() {
            try {
                const saved = localStorage.getItem(TEAM_KEY);
                if (saved) {
                    savedTeam = JSON.parse(saved);
                }
            } catch (e) {
                console.error('Error loading team:', e);
            }
        }

        // Save team to localStorage and Firebase
        function saveTeam() {
            try {
                localStorage.setItem(TEAM_KEY, JSON.stringify(savedTeam));
                saveTeamToFirebase(); // Sync to Firebase
            } catch (e) {
                console.error('Error saving team:', e);
            }
        }

        // Load history from localStorage
        function loadHistory() {
            try {
                const saved = localStorage.getItem(HISTORY_KEY);
                if (saved) {
                    splitHistory = JSON.parse(saved);
                }
            } catch (e) {
                console.error('Error loading history:', e);
            }
        }

        // Save history to localStorage and Firebase
        function saveHistoryToStorage() {
            try {
                localStorage.setItem(HISTORY_KEY, JSON.stringify(splitHistory));
                saveHistoryToFirebase(); // Sync to Firebase
            } catch (e) {
                console.error('Error saving history:', e);
            }
        }

        // Save bill options to localStorage
        function saveBillOptions() {
            try {
                const options = {
                    hasService: document.getElementById('hasService').checked,
                    serviceRate: parseFloat(document.getElementById('serviceRate').value) || 10,
                    hasGST: document.getElementById('hasGST').checked,
                    gstRate: parseFloat(document.getElementById('gstRate').value) || 9,
                    discountValue: parseFloat(document.getElementById('discountValue').value) || 0,
                    discountType: document.getElementById('discountType').value,
                    roundingType: document.getElementById('roundingType').value
                };
                localStorage.setItem(BILL_OPTIONS_KEY, JSON.stringify(options));
            } catch (e) {
                console.error('Error saving bill options:', e);
            }
        }

        // Load bill options from localStorage
        function loadBillOptions() {
            try {
                const saved = localStorage.getItem(BILL_OPTIONS_KEY);
                if (saved) {
                    const options = JSON.parse(saved);
                    document.getElementById('hasService').checked = options.hasService || false;
                    document.getElementById('serviceRate').value = options.serviceRate || 10;
                    document.getElementById('hasGST').checked = options.hasGST !== false;
                    document.getElementById('gstRate').value = options.gstRate || 9;
                    if (options.discountValue > 0) {
                        document.getElementById('discountValue').value = options.discountValue;
                    }
                    document.getElementById('discountType').value = options.discountType || 'amount';
                    document.getElementById('roundingType').value = options.roundingType || 'none';
                }
            } catch (e) {
                console.error('Error loading bill options:', e);
            }
        }

        // Render saved team
        function renderSavedTeam() {
            const list = document.getElementById('savedTeamList');
            if (savedTeam.length === 0) {
                list.innerHTML = '<span style="font-size: 12px; color: #888;">Add people to build your team</span>';
                return;
            }
            list.innerHTML = savedTeam.map(name => `
                <div class="saved-person ${people.includes(name) ? 'selected' : ''}" onclick="toggleSavedPerson('${name}')">
                    ${name}
                    <span class="delete-saved" onclick="event.stopPropagation(); deleteSavedPerson('${name}')">√ó</span>
                </div>
            `).join('');
        }

        // Toggle saved person in/out of current session
        function toggleSavedPerson(name) {
            if (people.includes(name)) {
                removePerson(name);
            } else {
                addPerson(name);
            }
            renderSavedTeam();
        }

        // Delete from saved team
        function deleteSavedPerson(name) {
            savedTeam = savedTeam.filter(n => n !== name);
            saveTeam();
            renderSavedTeam();
            showToast(`Removed ${name} from team`);
        }

        // ==================== QUICK SPLIT FUNCTIONS ====================

        // Split all items equally among everyone
        function splitAllEqually() {
            if (people.length === 0) {
                showToast('Add people first!');
                return;
            }
            if (items.length === 0) {
                showToast('Add items first!');
                return;
            }

            saveStateForUndo(); // Save state before change
            items.forEach(item => {
                item.people = [...people]; // Assign everyone to every item
            });

            renderItems();
            calculate();
            syncSessionToFirebase(); // Real-time sync
            showToast('All items split equally!');
        }

        // Each person gets their own items (for manual assignment)
        function splitEachOwn() {
            if (people.length === 0) {
                showToast('Add people first!');
                return;
            }

            saveStateForUndo(); // Save state before change
            // Clear all assignments so user can manually assign
            items.forEach(item => {
                item.people = [];
            });

            renderItems();
            calculate();
            syncSessionToFirebase(); // Real-time sync
            showToast('Cleared! Now assign each item to its owner');
        }

        // Clear all item assignments
        function clearAllAssignments() {
            saveStateForUndo(); // Save state before change
            items.forEach(item => {
                item.people = [];
            });

            renderItems();
            calculate();
            syncSessionToFirebase(); // Real-time sync
            showToast('All assignments cleared');
        }

        // Start a new session (fresh bill)
        function startNewSession() {
            if (items.length > 0 || people.length > 0) {
                if (!confirm('Start a new session? Current data will be cleared.\n\nTip: Save to history first if you want to keep it.')) {
                    return;
                }
            }

            saveStateForUndo(); // Save state before change (allows undo of new session)

            // Reset session
            currentSessionId = new Date().toISOString().split('T')[0] + '_' + Date.now();
            currentReceiptUrl = null;
            people = [];
            items = [];
            itemIdCounter = 0;
            paidStatus = {};

            // Reset bill options to defaults
            document.getElementById('hasService').checked = false;
            document.getElementById('serviceRate').value = 10;
            document.getElementById('hasGST').checked = true;
            document.getElementById('gstRate').value = 9;
            document.getElementById('discountValue').value = '';
            document.getElementById('discountType').value = 'amount';
            document.getElementById('roundingType').value = 'none';
            document.getElementById('expectedTotal').value = '';

            // Clear undo/redo stacks for fresh session
            undoStack = [];
            redoStack = [];
            updateUndoRedoButtons();

            // Add one empty item
            addItem();

            renderPeople();
            renderSavedTeam();
            calculate();
            syncSessionToFirebase(); // Sync new session to team
            hideReceiptPreview();
            showToast('New session started');
        }

        // Select all team members
        function selectAllTeam() {
            saveStateForUndo(); // Save state before change
            savedTeam.forEach(name => {
                if (!people.includes(name)) {
                    people.push(name);
                    items.forEach(item => {
                        if (!item.people.includes(name)) {
                            item.people.push(name);
                        }
                    });
                }
            });
            renderPeople();
            renderItems();
            renderSavedTeam();
            calculate();
            syncSessionToFirebase(); // Real-time sync
        }

        // Deselect all team members
        function selectNoneTeam() {
            saveStateForUndo(); // Save state before change
            people = [];
            items.forEach(item => item.people = []);
            renderPeople();
            renderItems();
            renderSavedTeam();
            calculate();
            syncSessionToFirebase(); // Real-time sync
        }

        // Tab switching
        function switchTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.querySelector(`[onclick="switchTab('${tab}')"]`).classList.add('active');
            document.getElementById(`tab-${tab}`).classList.add('active');
        }

        // Sub-tab switching within Split Bill
        function switchSubTab(subtab) {
            document.querySelectorAll('.sub-tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.sub-tab-content').forEach(content => content.classList.remove('active'));
            document.querySelector(`[onclick="switchSubTab('${subtab}')"]`).classList.add('active');
            document.getElementById(`subtab-${subtab}`).classList.add('active');
        }

        // Show toast notification
        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 2500);
        }
        
        function addPerson(name) {
            const inputName = name || document.getElementById('newPersonName').value.trim();
            if (!inputName) return;

            if (!people.includes(inputName)) {
                saveStateForUndo(); // Save state before change
                people.push(inputName);
                // Also save to team if new
                if (!savedTeam.includes(inputName)) {
                    savedTeam.push(inputName);
                    saveTeam();
                }
                renderPeople();
                renderItems();
                renderSavedTeam();
                calculate();
                syncSessionToFirebase(); // Real-time sync
            }

            document.getElementById('newPersonName').value = '';
        }

        function removePerson(name) {
            saveStateForUndo(); // Save state before change
            people = people.filter(p => p !== name);
            // Remove from all items
            items.forEach(item => {
                item.people = item.people.filter(p => p !== name);
            });
            renderPeople();
            renderItems();
            calculate();
            syncSessionToFirebase(); // Real-time sync
        }
        
        function renderPeople() {
            const list = document.getElementById('peopleList');
            list.innerHTML = people.map(p => `
                <div class="person-tag">
                    ${p}
                    <span class="remove" onclick="removePerson('${p}')">√ó</span>
                </div>
            `).join('');
        }
        
        function addItem() {
            saveStateForUndo(); // Save state before change
            items.push({
                id: itemIdCounter++,
                name: '',
                price: 0,
                people: [...people] // Default: everyone shares
            });
            renderItems();
            syncSessionToFirebase(); // Real-time sync
        }

        function removeItem(id) {
            saveStateForUndo(); // Save state before change
            items = items.filter(i => i.id !== id);
            renderItems();
            calculate();
            syncSessionToFirebase(); // Real-time sync
        }

        // Debounce timer for updateItem to avoid saving state on every keystroke
        let updateItemTimer = null;
        let lastSavedItemState = null;

        function updateItem(id, field, value) {
            const item = items.find(i => i.id === id);
            if (item) {
                // Save state only once when user starts typing (debounced)
                if (!updateItemTimer) {
                    saveStateForUndo();
                }
                clearTimeout(updateItemTimer);
                updateItemTimer = setTimeout(() => {
                    updateItemTimer = null;
                }, 1000); // Reset after 1 second of inactivity

                item[field] = field === 'price' ? (parseFloat(value) || 0) : value;
                calculate();
                syncSessionToFirebase(); // Real-time sync
            }
        }

        function togglePerson(itemId, person) {
            const item = items.find(i => i.id === itemId);
            if (item) {
                saveStateForUndo(); // Save state before change
                if (item.people.includes(person)) {
                    item.people = item.people.filter(p => p !== person);
                } else {
                    item.people.push(person);
                }
                renderItems();
                calculate();
                syncSessionToFirebase(); // Real-time sync
            }
        }
        
        function renderItems() {
            const list = document.getElementById('itemsList');
            
            if (items.length === 0) {
                list.innerHTML = '<div class="no-items">No items added yet</div>';
                return;
            }
            
            list.innerHTML = items.map(item => `
                <div class="item-row">
                    <div class="item-main">
                        <input type="text" class="item-name" placeholder="Item name" 
                            value="${item.name}" 
                            oninput="updateItem(${item.id}, 'name', this.value)">
                        <input type="number" class="item-price" placeholder="0.00" step="0.01"
                            value="${item.price || ''}"
                            oninput="updateItem(${item.id}, 'price', this.value)">
                        <button class="remove-item-btn" onclick="removeItem(${item.id})">√ó</button>
                    </div>
                    <div class="item-people">
                        <div class="item-people-label">Who's sharing this?</div>
                        ${people.map(p => `
                            <input type="checkbox" class="person-checkbox" 
                                id="item${item.id}_${p}" 
                                ${item.people.includes(p) ? 'checked' : ''}
                                onchange="togglePerson(${item.id}, '${p}')">
                            <label class="person-label" for="item${item.id}_${p}">${p}</label>
                        `).join('')}
                    </div>
                </div>
            `).join('');
        }
        
        function calculate() {
            // Calculate subtotal
            let subtotal = 0;
            items.forEach(item => {
                subtotal += item.price || 0;
            });

            // 1. Discount FIRST (applied to subtotal)
            const discountValue = parseFloat(document.getElementById('discountValue').value) || 0;
            const discountType = document.getElementById('discountType').value;
            let discountAmt = 0;
            if (discountType === 'percent') {
                discountAmt = subtotal * (discountValue / 100);
            } else {
                discountAmt = discountValue;
            }

            // Subtotal after discount
            const subtotalAfterDiscount = subtotal - discountAmt;

            // 2. Service charge (applied AFTER discount)
            const hasService = document.getElementById('hasService').checked;
            const serviceRate = parseFloat(document.getElementById('serviceRate').value) || 10;
            const serviceAmt = hasService ? subtotalAfterDiscount * (serviceRate / 100) : 0;

            // 3. GST (applied to subtotal after discount + service)
            const taxable = subtotalAfterDiscount + serviceAmt;
            const hasGST = document.getElementById('hasGST').checked;
            const gstRate = parseFloat(document.getElementById('gstRate').value) || 9;
            const gstAmt = hasGST ? taxable * (gstRate / 100) : 0;

            // Total
            const total = taxable + gstAmt;

            // Update summary display
            document.getElementById('subtotalDisplay').textContent = `S$ ${subtotal.toFixed(2)}`;
            document.getElementById('discountRow').style.display = discountAmt > 0 ? 'flex' : 'none';
            document.getElementById('discountDisplay').textContent = `-S$ ${discountAmt.toFixed(2)}`;
            document.getElementById('subtotalAfterDiscountRow').style.display = discountAmt > 0 ? 'flex' : 'none';
            document.getElementById('subtotalAfterDiscountDisplay').textContent = `S$ ${subtotalAfterDiscount.toFixed(2)}`;
            document.getElementById('svcPct').textContent = serviceRate;
            document.getElementById('serviceRow').style.display = hasService ? 'flex' : 'none';
            document.getElementById('serviceDisplay').textContent = `S$ ${serviceAmt.toFixed(2)}`;
            document.getElementById('gstPct').textContent = gstRate;
            document.getElementById('gstRow').style.display = hasGST ? 'flex' : 'none';
            document.getElementById('gstDisplay').textContent = `S$ ${gstAmt.toFixed(2)}`;
            document.getElementById('totalDisplay').textContent = `S$ ${total.toFixed(2)}`;

            // Show/hide share actions
            const hasData = people.length > 0 && subtotal > 0;
            document.getElementById('shareActions').style.display = hasData ? 'flex' : 'none';

            // Check if total matches expected
            checkTotalMatch(total);

            // Calculate per-person breakdown
            calculatePersonBreakdown(subtotal, serviceAmt, discountAmt, gstAmt, total);
        }

        // Check if calculated total matches expected total
        function checkTotalMatch(calculatedTotal) {
            const expectedInput = document.getElementById('expectedTotal');
            const matchDiv = document.getElementById('totalMatch');
            const differenceRow = document.getElementById('differenceRow');
            const differenceLabel = document.getElementById('differenceLabel');
            const differenceAmount = document.getElementById('differenceAmount');
            const expected = parseFloat(expectedInput.value) || 0;

            if (expected <= 0) {
                matchDiv.className = 'total-match';
                matchDiv.innerHTML = '';
                differenceRow.className = 'summary-row difference-row';
                return false;
            }

            if (calculatedTotal === undefined) {
                // Get current total from display
                const totalText = document.getElementById('totalDisplay').textContent;
                calculatedTotal = parseFloat(totalText.replace(/[^0-9.]/g, '')) || 0;
            }

            const diff = calculatedTotal - expected;
            const absDiff = Math.abs(diff);

            // Update difference row display
            if (absDiff < 0.05) {
                // Match - amounts are equal
                differenceRow.className = 'summary-row difference-row show match';
                differenceLabel.textContent = 'Difference';
                differenceAmount.innerHTML = '‚úÖ S$ 0.00';

                matchDiv.className = 'total-match match';
                matchDiv.innerHTML = `
                    <span class="match-icon">‚úÖ</span>
                    Total matches receipt!
                    <div class="match-hint">Safe to share with your team</div>
                `;
                return true;
            } else if (diff > 0) {
                // Over - calculated is higher than receipt
                differenceRow.className = 'summary-row difference-row show over';
                differenceLabel.textContent = 'Over by';
                differenceAmount.innerHTML = `+S$ ${absDiff.toFixed(2)}`;

                matchDiv.className = 'total-match mismatch';
                matchDiv.innerHTML = `
                    <span class="match-icon">‚ö†Ô∏è</span>
                    You're charging S$${absDiff.toFixed(2)} more than receipt
                    <div class="match-hint">Receipt: S$${expected.toFixed(2)} ‚Ä¢ Check items or reduce amounts</div>
                `;
                return false;
            } else {
                // Under - calculated is lower than receipt
                differenceRow.className = 'summary-row difference-row show under';
                differenceLabel.textContent = 'Under by';
                differenceAmount.innerHTML = `-S$ ${absDiff.toFixed(2)}`;

                matchDiv.className = 'total-match mismatch';
                matchDiv.innerHTML = `
                    <span class="match-icon">‚ö†Ô∏è</span>
                    You're missing S$${absDiff.toFixed(2)} from receipt
                    <div class="match-hint">Receipt: S$${expected.toFixed(2)} ‚Ä¢ Check for missing items</div>
                `;
                return false;
            }
        }

        // Check if totals match before critical actions
        function isTotalMatched() {
            const expected = parseFloat(document.getElementById('expectedTotal').value) || 0;
            if (expected <= 0) return true; // No expected total set, allow action

            const totalText = document.getElementById('totalDisplay').textContent;
            const calculated = parseFloat(totalText.replace(/[^0-9.]/g, '')) || 0;
            return Math.abs(calculated - expected) < 0.05;
        }

        // Rounding helper
        function roundAmount(amount) {
            const roundType = document.getElementById('roundingType').value;
            if (roundType === 'none') return amount;
            const step = parseFloat(roundType);
            return Math.ceil(amount / step) * step;
        }
        
        function calculatePersonBreakdown(subtotal, serviceAmt, discountAmt, gstAmt, total) {
            const breakdownList = document.getElementById('breakdownList');
            
            if (people.length === 0) {
                breakdownList.innerHTML = '<div class="no-items">Add people to see breakdown</div>';
                return;
            }
            
            // Calculate each person's share
            const personData = people.map(person => {
                // Get items for this person
                const personItems = items.filter(item => item.people.includes(person));
                
                // Calculate their subtotal (split shared items)
                let personSubtotal = 0;
                const itemDetails = [];
                
                personItems.forEach(item => {
                    const shareCount = item.people.length || 1;
                    const share = (item.price || 0) / shareCount;
                    personSubtotal += share;
                    if (item.price > 0) {
                        itemDetails.push({
                            name: item.name || 'Item',
                            price: item.price,
                            share: share,
                            shared: shareCount > 1 ? shareCount : 0
                        });
                    }
                });
                
                // Calculate proportion of extras (discount first, then service on discounted amount)
                const proportion = subtotal > 0 ? personSubtotal / subtotal : 0;
                const personDiscount = discountAmt * proportion;
                const personSubtotalAfterDiscount = personSubtotal - personDiscount;
                const personService = serviceAmt * proportion;
                const personGst = gstAmt * proportion;
                const exactTotal = personSubtotalAfterDiscount + personService + personGst;
                const personTotal = roundAmount(exactTotal);

                return {
                    name: person,
                    items: itemDetails,
                    subtotal: personSubtotal,
                    discount: personDiscount,
                    service: personService,
                    gst: personGst,
                    exactTotal: exactTotal,
                    total: personTotal
                };
            });
            
            // Render breakdown
            breakdownList.innerHTML = personData.map((p, idx) => {
                const isPaid = paidStatus[p.name] || false;
                return `
                <div class="person-breakdown">
                    <div class="person-header ${isPaid ? 'paid' : ''}" onclick="toggleDetails(${idx})">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span class="person-name">${p.name}</span>
                            ${isPaid ? '<span style="font-size: 12px;">‚úì Paid</span>' : ''}
                        </div>
                        <div style="display: flex; align-items: center;">
                            <span class="person-total">S$ ${p.total.toFixed(2)}</span>
                            <button class="paid-btn ${isPaid ? 'is-paid' : ''}" onclick="event.stopPropagation(); togglePaid('${p.name}')">
                                ${isPaid ? '‚úì Paid' : 'Mark Paid'}
                            </button>
                        </div>
                    </div>
                    <div class="person-details" id="details${idx}">
                        ${p.items.length > 0 ? p.items.map(item => `
                            <div class="detail-row item">
                                <span>${item.name} ${item.shared > 1 ? `<span class="shared">(√∑${item.shared})</span>` : ''}</span>
                                <span>S$ ${item.share.toFixed(2)}</span>
                            </div>
                        `).join('') : '<div class="detail-row"><span>No items</span><span>S$ 0.00</span></div>'}
                        ${p.service > 0 ? `<div class="detail-row"><span>Service</span><span>S$ ${p.service.toFixed(2)}</span></div>` : ''}
                        ${p.discount > 0 ? `<div class="detail-row"><span>Discount</span><span class="negative">-S$ ${p.discount.toFixed(2)}</span></div>` : ''}
                        ${p.gst > 0 ? `<div class="detail-row"><span>GST</span><span>S$ ${p.gst.toFixed(2)}</span></div>` : ''}
                        <button class="generate-person-btn" onclick="generateQR('${p.name}', ${p.total.toFixed(2)})">
                            Generate PayNow QR
                        </button>
                    </div>
                </div>
            `}).join('');
        }

        // Toggle paid status
        function togglePaid(name) {
            saveStateForUndo(); // Save state before change
            paidStatus[name] = !paidStatus[name];
            calculate();
            syncSessionToFirebase(); // Real-time sync
            showToast(paidStatus[name] ? `${name} marked as paid` : `${name} marked as unpaid`);
        }
        
        function toggleDetails(idx) {
            const details = document.getElementById(`details${idx}`);
            details.classList.toggle('show');
        }
        
        // PayNow QR Generation
        function calculateCRC(str) {
            let crc = 0xFFFF;
            for (let i = 0; i < str.length; i++) {
                crc ^= str.charCodeAt(i) << 8;
                for (let j = 0; j < 8; j++) {
                    crc = (crc & 0x8000) ? (crc << 1) ^ 0x1021 : crc << 1;
                }
            }
            return (crc & 0xFFFF).toString(16).toUpperCase().padStart(4, '0');
        }
        
        function tlv(tag, value) {
            return tag + value.length.toString().padStart(2, '0') + value;
        }
        
        function generatePayNowString(amount, reference) {
            let merchantAcctInfo = '';
            merchantAcctInfo += tlv('00', 'SG.PAYNOW');
            merchantAcctInfo += tlv('01', '0');
            merchantAcctInfo += tlv('02', getPayNowNumber());
            merchantAcctInfo += tlv('03', '1');
            
            let payload = '';
            payload += tlv('00', '01');
            payload += tlv('01', '12');
            payload += tlv('26', merchantAcctInfo);
            payload += tlv('52', '0000');
            payload += tlv('53', '702');
            
            if (amount && parseFloat(amount) > 0) {
                payload += tlv('54', parseFloat(amount).toFixed(2));
            }
            
            payload += tlv('58', 'SG');
            payload += tlv('59', 'NA');
            payload += tlv('60', 'Singapore');
            
            if (reference && reference.trim()) {
                payload += tlv('62', tlv('01', reference.trim().substring(0, 25)));
            }
            
            payload += '6304';
            payload += calculateCRC(payload);
            
            return payload;
        }
        
        // PayNow logo as base64 data URI (pink "P" icon)
        const PAYNOW_LOGO = 'data:image/svg+xml;base64,' + btoa(`
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100">
                <circle cx="50" cy="50" r="48" fill="white"/>
                <circle cx="50" cy="50" r="44" fill="#D42B6F"/>
                <text x="50" y="68" text-anchor="middle" font-family="Arial, sans-serif" font-size="52" font-weight="bold" fill="white">P</text>
            </svg>
        `);

        function addLogoToQR(qrDiv, logoSize = 50) {
            // Wait for QR code canvas to be created
            setTimeout(() => {
                const canvas = qrDiv.querySelector('canvas');
                if (!canvas) return;

                const ctx = canvas.getContext('2d');
                const logo = new Image();
                logo.onload = function() {
                    const x = (canvas.width - logoSize) / 2;
                    const y = (canvas.height - logoSize) / 2;

                    // Draw white circle background for better contrast
                    ctx.beginPath();
                    ctx.arc(canvas.width / 2, canvas.height / 2, logoSize / 2 + 4, 0, Math.PI * 2);
                    ctx.fillStyle = 'white';
                    ctx.fill();

                    // Draw the logo
                    ctx.drawImage(logo, x, y, logoSize, logoSize);
                };
                logo.src = PAYNOW_LOGO;
            }, 50);
        }

        function generateQR(name, amount) {
            const qrDiv = document.getElementById('qrcode');
            qrDiv.innerHTML = '';

            const today = new Date().toLocaleDateString('en-GB', { day: 'numeric', month: 'short' });
            const reference = `${name} ${today}`;
            const payNowString = generatePayNowString(amount, reference);

            qrcode = new QRCode(qrDiv, {
                text: payNowString,
                width: 180,
                height: 180,
                colorDark: '#7B2D8E',
                colorLight: '#ffffff',
                correctLevel: QRCode.CorrectLevel.H  // High error correction for logo overlay
            });

            // Add PayNow logo to center of QR code
            addLogoToQR(qrDiv, 45);

            document.getElementById('modalName').textContent = name;
            document.getElementById('modalAmount').textContent = `S$ ${parseFloat(amount).toFixed(2)}`;
            document.getElementById('qrModal').classList.add('show');
        }
        
        function closeModal(event) {
            if (!event || event.target === document.getElementById('qrModal')) {
                document.getElementById('qrModal').classList.remove('show');
            }
        }

        // ==================== SETTINGS ====================

        function getPayNowNumber() {
            return localStorage.getItem(PAYNOW_NUMBER_KEY) || DEFAULT_PAYNOW_NUMBER;
        }

        function getPayNowDisplay() {
            const num = getPayNowNumber();
            // Format: +65 8339 9525
            return num.replace(/(\+65)(\d{4})(\d{4})/, '$1 $2 $3');
        }

        function openSettings() {
            const modal = document.getElementById('settingsModal');
            const input = document.getElementById('paynowNumberInput');
            // Load current number (without +65 prefix)
            const currentNumber = getPayNowNumber().replace('+65', '');
            input.value = currentNumber;
            input.classList.remove('error');
            modal.classList.add('show');
        }

        function closeSettings(event) {
            if (!event || event.target === document.getElementById('settingsModal')) {
                document.getElementById('settingsModal').classList.remove('show');
            }
        }

        function saveSettings() {
            const input = document.getElementById('paynowNumberInput');
            const number = input.value.trim();

            // Validate: 8 digits starting with 8 or 9
            if (!/^[89]\d{7}$/.test(number)) {
                input.classList.add('error');
                showToast('Please enter a valid Singapore phone number (8 digits starting with 8 or 9)');
                return;
            }

            // Save with +65 prefix
            const fullNumber = '+65' + number;
            localStorage.setItem(PAYNOW_NUMBER_KEY, fullNumber);

            // Update displayed phone info
            updatePayNowDisplay();

            closeSettings();
            showToast('PayNow number saved!');
        }

        function updatePayNowDisplay() {
            const phoneInfo = document.querySelector('.phone-info');
            if (phoneInfo) {
                phoneInfo.textContent = 'PayNow to ' + getPayNowDisplay();
            }
        }

        function downloadQR() {
            const canvas = document.querySelector('#qrcode canvas');
            if (canvas) {
                const name = document.getElementById('modalName').textContent;
                const link = document.createElement('a');
                link.download = `paynow-${name.toLowerCase().replace(/\s+/g, '-')}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
            }
        }

        // ==================== SHARING ====================

        // Generate share text
        function generateShareText() {
            const today = new Date().toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });
            let text = `üçú Lunch Split - ${today}\n\n`;

            const personData = getPersonData();
            personData.forEach(p => {
                if (p.total > 0) {
                    text += `${p.name}: S$${p.total.toFixed(2)}\n`;
                }
            });

            const total = personData.reduce((sum, p) => sum + p.total, 0);
            text += `\nüí∞ Total: S$${total.toFixed(2)}`;
            text += `\n\nPayNow to ${getPayNowDisplay()}`;

            return text;
        }

        // Get person data for sharing
        function getPersonData() {
            let subtotal = 0;
            items.forEach(item => subtotal += item.price || 0);

            const hasService = document.getElementById('hasService').checked;
            const serviceRate = parseFloat(document.getElementById('serviceRate').value) || 10;
            const serviceAmt = hasService ? subtotal * (serviceRate / 100) : 0;

            const discountValue = parseFloat(document.getElementById('discountValue').value) || 0;
            const discountType = document.getElementById('discountType').value;
            let discountAmt = discountType === 'percent' ? subtotal * (discountValue / 100) : discountValue;

            const taxable = subtotal + serviceAmt - discountAmt;
            const hasGST = document.getElementById('hasGST').checked;
            const gstRate = parseFloat(document.getElementById('gstRate').value) || 9;
            const gstAmt = hasGST ? taxable * (gstRate / 100) : 0;

            return people.map(person => {
                const personItems = items.filter(item => item.people.includes(person));
                let personSubtotal = 0;
                personItems.forEach(item => {
                    const shareCount = item.people.length || 1;
                    personSubtotal += (item.price || 0) / shareCount;
                });

                const proportion = subtotal > 0 ? personSubtotal / subtotal : 0;
                const exactTotal = personSubtotal + (serviceAmt * proportion) - (discountAmt * proportion) + (gstAmt * proportion);
                return { name: person, total: roundAmount(exactTotal) };
            });
        }

        // Share via WhatsApp
        function shareWhatsApp() {
            if (!isTotalMatched()) {
                if (!confirm('‚ö†Ô∏è Total doesn\'t match receipt!\n\nAre you sure you want to share anyway?')) {
                    return;
                }
            }
            const text = encodeURIComponent(generateShareText());
            window.open(`https://wa.me/?text=${text}`, '_blank');
        }

        // Copy share link
        function copyShareLink() {
            if (!isTotalMatched()) {
                if (!confirm('‚ö†Ô∏è Total doesn\'t match receipt!\n\nAre you sure you want to copy the link anyway?')) {
                    return;
                }
            }
            const data = {
                p: people,
                i: items.map(it => ({ n: it.name, pr: it.price, ppl: it.people })),
                svc: document.getElementById('hasService').checked ? parseFloat(document.getElementById('serviceRate').value) : 0,
                gst: document.getElementById('hasGST').checked ? parseFloat(document.getElementById('gstRate').value) : 0,
                disc: parseFloat(document.getElementById('discountValue').value) || 0,
                discType: document.getElementById('discountType').value
            };
            const encoded = btoa(encodeURIComponent(JSON.stringify(data)));
            const url = `${window.location.origin}${window.location.pathname}?d=${encoded}`;

            navigator.clipboard.writeText(url).then(() => {
                showToast('Link copied to clipboard!');
            }).catch(() => {
                showToast('Failed to copy link');
            });
        }

        // Send final breakdown to Seatalk via n8n webhook
        async function sendToSeatalk() {
            if (!seatalkChatId) {
                showToast('No Seatalk chat linked');
                return;
            }

            if (!isTotalMatched()) {
                if (!confirm('‚ö†Ô∏è Total doesn\'t match receipt!\n\nAre you sure you want to send to Seatalk anyway?')) {
                    return;
                }
            }

            const personData = getPersonData();
            if (personData.length === 0 || personData.every(p => p.total === 0)) {
                showToast('No breakdown to send!');
                return;
            }

            const btn = document.getElementById('seatalkBtn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '‚è≥ Sending...';
            btn.disabled = true;

            try {
                const today = new Date();
                const dateStr = today.toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });

                const payload = {
                    chat_id: seatalkChatId,
                    breakdown: personData.map(p => ({
                        name: p.name,
                        amount: p.total,
                        items: p.items ? p.items.map(i => i.name) : []
                    })),
                    paynow_number: getPayNowNumber(),
                    date: dateStr,
                    total: personData.reduce((sum, p) => sum + p.total, 0)
                };

                const response = await fetch(N8N_SEATALK_WEBHOOK_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (response.ok) {
                    btn.innerHTML = '‚úÖ Sent!';
                    showToast('Sent to Seatalk! üéâ');
                    setTimeout(() => {
                        btn.innerHTML = originalText;
                        btn.disabled = false;
                    }, 2000);
                } else {
                    throw new Error('Failed to send');
                }
            } catch (e) {
                console.error('Error sending to Seatalk:', e);
                btn.innerHTML = originalText;
                btn.disabled = false;
                showToast('Failed to send to Seatalk');
            }
        }

        // Check URL params for shared data
        function checkUrlParams() {
            const params = new URLSearchParams(window.location.search);
            const data = params.get('d');
            const chatId = params.get('chat_id');

            // Check for Seatalk chat_id
            if (chatId) {
                seatalkChatId = decodeURIComponent(chatId);
                // Show Seatalk button
                const seatalkBtn = document.getElementById('seatalkBtn');
                if (seatalkBtn) {
                    seatalkBtn.style.display = 'inline-flex';
                }
                console.log('Seatalk chat_id detected:', seatalkChatId);
            }

            if (data) {
                try {
                    const decoded = JSON.parse(decodeURIComponent(atob(data)));
                    people = decoded.p || [];
                    items = (decoded.i || []).map((it, idx) => ({
                        id: idx,
                        name: it.n,
                        price: it.pr,
                        people: it.ppl
                    }));
                    itemIdCounter = items.length;

                    if (decoded.svc > 0) {
                        document.getElementById('hasService').checked = true;
                        document.getElementById('serviceRate').value = decoded.svc;
                    }
                    if (decoded.gst > 0) {
                        document.getElementById('hasGST').checked = true;
                        document.getElementById('gstRate').value = decoded.gst;
                    }
                    if (decoded.disc > 0) {
                        document.getElementById('discountValue').value = decoded.disc;
                        document.getElementById('discountType').value = decoded.discType || 'amount';
                    }

                    renderPeople();
                    renderItems();
                    calculate();
                    showToast('Loaded shared bill' + (seatalkChatId ? ' from Seatalk' : ''));

                    // Clear URL params (keep functionality but remove from display)
                    window.history.replaceState({}, '', window.location.pathname);
                } catch (e) {
                    console.error('Error loading shared data:', e);
                }
            }
        }

        // ==================== HISTORY ====================

        // Save current split to history (one receipt = one history entry)
        function saveToHistory() {
            const today = new Date();
            const personData = getPersonData();
            const total = personData.reduce((sum, p) => sum + p.total, 0);

            const entry = {
                id: Date.now(),
                sessionId: currentSessionId, // Link to current session
                receiptUrl: currentReceiptUrl, // Link to receipt if any
                date: today.toISOString(),
                people: [...people],
                items: items.map(it => ({ name: it.name, price: it.price, people: it.people })),
                total: total,
                breakdown: personData
            };

            // Check if there's an existing entry for this session (one receipt = one history)
            let existingIndex = -1;
            if (currentSessionId) {
                existingIndex = splitHistory.findIndex(h => h.sessionId === currentSessionId);
            }
            // Also check by receipt URL if no session match
            if (existingIndex === -1 && currentReceiptUrl) {
                existingIndex = splitHistory.findIndex(h => h.receiptUrl === currentReceiptUrl);
            }

            if (existingIndex !== -1) {
                // Update existing entry instead of creating new
                entry.id = splitHistory[existingIndex].id; // Keep original ID
                splitHistory[existingIndex] = entry;
                showToast('Updated existing history entry');
            } else {
                // Create new entry
                splitHistory.unshift(entry);
                if (splitHistory.length > 50) splitHistory.pop(); // Keep last 50
                showToast('Saved to history');
            }

            saveHistoryToStorage();
            renderHistory();
        }

        // Render history list
        function renderHistory() {
            const list = document.getElementById('historyList');
            if (splitHistory.length === 0) {
                list.innerHTML = '<div class="no-items">No saved splits yet</div>';
                return;
            }

            list.innerHTML = splitHistory.map(entry => {
                const date = new Date(entry.date);
                const dateStr = date.toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });
                const timeStr = date.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
                return `
                    <div class="history-item" onclick="loadHistory(${entry.id})">
                        <div class="history-info">
                            <div class="history-date">${dateStr} ${timeStr}</div>
                            <div class="history-people">${entry.people.join(', ')}</div>
                        </div>
                        <div class="history-total">S$ ${entry.total.toFixed(2)}</div>
                        <button class="history-delete" onclick="event.stopPropagation(); deleteHistory(${entry.id})">√ó</button>
                    </div>
                `;
            }).join('');
        }

        // Load a history entry
        function loadHistory(id) {
            const entry = splitHistory.find(e => e.id === id);
            if (!entry) return;

            // Set session ID so future saves update this entry
            currentSessionId = entry.sessionId || null;
            currentReceiptUrl = entry.receiptUrl || null;

            people = [...entry.people];
            items = entry.items.map((it, idx) => ({
                id: idx,
                name: it.name,
                price: it.price,
                people: it.people
            }));
            itemIdCounter = items.length;

            renderPeople();
            renderItems();
            renderSavedTeam();
            calculate();
            syncSessionToFirebase(); // Sync loaded session to team
            switchTab('split');
            showToast('Loaded from history');
        }

        // Delete history entry
        function deleteHistory(id) {
            splitHistory = splitHistory.filter(e => e.id !== id);
            saveHistoryToStorage();
            renderHistory();
            showToast('Deleted from history');
        }

        // Clear all history
        function clearHistory() {
            if (confirm('Clear all history?')) {
                splitHistory = [];
                saveHistoryToStorage();
                renderHistory();
                showToast('History cleared');
            }
        }

        // ==================== RECEIPT IMAGE SHARING (Firebase Storage) ====================

        // Upload receipt image to Firebase Storage
        async function uploadReceiptToFirebase(file) {
            if (!currentTeamCode) return;

            try {
                const today = new Date();
                const dateStr = today.toISOString().split('T')[0]; // YYYY-MM-DD
                const fileName = `receipts/${currentTeamCode}/${dateStr}_${Date.now()}.jpg`;

                const storageRef = storage.ref(fileName);
                const snapshot = await storageRef.put(file);
                const downloadUrl = await snapshot.ref.getDownloadURL();

                // Save URL to Firestore for team to see
                await db.collection('teams').doc(currentTeamCode).update({
                    receiptUrl: downloadUrl,
                    receiptDate: today.toISOString(),
                    receiptUploader: 'Team member' // Could add user name later
                });

                console.log('Receipt uploaded:', downloadUrl);
                return downloadUrl;

            } catch (e) {
                console.error('Error uploading receipt:', e);
            }
        }

        // Show receipt preview
        function showReceiptPreview(url, dateStr, uploader) {
            const section = document.getElementById('receiptPreviewSection');
            const thumbnail = document.getElementById('receiptThumbnail');
            const meta = document.getElementById('receiptMeta');
            const dateBadge = document.getElementById('receiptDate');

            thumbnail.src = url;
            currentReceiptUrl = url;

            // Format date
            const date = new Date(dateStr);
            const today = new Date();
            const isToday = date.toDateString() === today.toDateString();

            if (isToday) {
                const timeAgo = getTimeAgo(date);
                meta.textContent = `Uploaded ${timeAgo}`;
            } else {
                meta.textContent = `Uploaded on ${date.toLocaleDateString('en-GB', { day: 'numeric', month: 'short' })}`;
            }

            dateBadge.textContent = date.toLocaleDateString('en-GB', { weekday: 'short', day: 'numeric', month: 'short' });

            section.classList.add('show');
        }

        // Hide receipt preview
        function hideReceiptPreview() {
            document.getElementById('receiptPreviewSection').classList.remove('show');
            currentReceiptUrl = null;
        }

        // Get time ago string
        function getTimeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            if (seconds < 60) return 'just now';
            const minutes = Math.floor(seconds / 60);
            if (minutes < 60) return `${minutes}m ago`;
            const hours = Math.floor(minutes / 60);
            if (hours < 24) return `${hours}h ago`;
            const days = Math.floor(hours / 24);
            return `${days}d ago`;
        }

        // Show full receipt modal
        function showReceiptModal() {
            if (!currentReceiptUrl) return;
            document.getElementById('receiptFullImage').src = currentReceiptUrl;
            document.getElementById('receiptModal').classList.add('show');
        }

        // Close receipt modal
        function closeReceiptModal() {
            document.getElementById('receiptModal').classList.remove('show');
        }

        // ==================== Receipt Scanning (ai.insea.io API) ====================

        const INSEA_API_KEY = 'yz1PZMqqNAQRVXeOmie0gkaDft9I2l0R';
        const INSEA_API_URL = 'https://ai.insea.io/api/workflows/10902/run';

        // Handle receipt upload
        async function handleReceiptUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Check file size (max 2MB for protection)
            if (file.size > 2 * 1024 * 1024) {
                showToast('Image too large! Max 2MB');
                return;
            }

            const status = document.getElementById('ocrStatus');
            status.className = 'ocr-status show';
            status.textContent = 'Uploading receipt...';

            try {
                // Upload image to Firebase Storage if connected to team
                if (currentTeamCode) {
                    await uploadReceiptToFirebase(file);
                }

                // Create FormData and send to ai.insea.io
                const formData = new FormData();
                formData.append('receipt_image', file);

                status.textContent = 'Analyzing receipt with AI...';

                const response = await fetch(INSEA_API_URL, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${INSEA_API_KEY}`
                    },
                    body: formData
                });

                if (!response.ok) {
                    throw new Error(`API error: ${response.status}`);
                }

                const result = await response.json();
                console.log('API Response:', result);

                // Parse the response from the API
                const outputs = result.data?.outputs || {};
                const splitResult = outputs.split_result || '';
                const extracted = parseInseaResult(splitResult);

                // Auto-fill bill options if provided
                if (outputs.service_charge && outputs.service_charge > 0) {
                    document.getElementById('hasService').checked = true;
                    // Calculate service charge percentage from subtotal after discount
                    const subtotalAfterDiscount = (outputs.subtotal || 0) - (outputs.discount || 0);
                    if (subtotalAfterDiscount > 0) {
                        const svcPct = (outputs.service_charge / subtotalAfterDiscount * 100).toFixed(1);
                        document.getElementById('serviceRate').value = svcPct;
                    }
                }
                if (outputs.discount && outputs.discount > 0) {
                    document.getElementById('discountValue').value = outputs.discount.toFixed(2);
                    document.getElementById('discountType').value = 'amount';
                }
                // Auto-fill expected total (grand_total from receipt)
                if (outputs.grand_total && outputs.grand_total > 0) {
                    document.getElementById('expectedTotal').value = outputs.grand_total.toFixed(2);
                }

                if (extracted.length > 0) {
                    // Show preview instead of adding directly
                    showOcrPreview(extracted);
                    status.textContent = `Found ${extracted.length} items - review below`;
                    setTimeout(() => { status.className = 'ocr-status'; }, 3000);
                } else {
                    status.className = 'ocr-status show error';
                    const rawText = typeof splitResult === 'string' ? splitResult : JSON.stringify(splitResult);
                    status.innerHTML = `No items found. <button onclick="showRawOcrText(\`${rawText.replace(/`/g, "'").replace(/\\/g, "\\\\").replace(/\n/g, "\\n")}\`)" style="margin-left:8px;padding:4px 8px;border:1px solid #c62828;background:white;border-radius:4px;cursor:pointer;">View Raw Text</button>`;
                }
            } catch (e) {
                console.error('API error:', e);
                status.className = 'ocr-status show error';
                status.textContent = 'Error analyzing receipt. Please try again.';
            }

            event.target.value = '';
        }

        // Parse the ai.insea.io result format
        function parseInseaResult(data) {
            console.log('Parsing result:', data);
            const items = [];

            // Handle JSON array format (new workflow)
            if (typeof data === 'string') {
                try {
                    data = JSON.parse(data);
                } catch (e) {
                    // Not JSON, try legacy text parsing
                    return parseLegacyTextFormat(data);
                }
            }

            // If it's an array of items
            if (Array.isArray(data)) {
                data.forEach(item => {
                    if (item.name && item.price !== undefined) {
                        items.push({
                            name: item.name,
                            price: parseFloat(item.price)
                        });
                    }
                });
            }

            console.log('Extracted items:', items);
            return items;
        }

        // Legacy text format parser (fallback)
        function parseLegacyTextFormat(text) {
            const items = [];
            const itemPattern = /^\d+\.\s*(.+?)\s*-\s*\$?([\d.]+)\s*$/gm;

            let match;
            while ((match = itemPattern.exec(text)) !== null) {
                let name = match[1].trim().replace(/\*\*/g, '');
                const price = parseFloat(match[2]);

                const skipWords = ['subtotal', 'total', 'discount', 'gst', 'tax', 'service', 'rounding', 'grand'];
                if (skipWords.some(word => name.toLowerCase().includes(word))) continue;

                if (price > 0 && price < 200 && name.length > 0) {
                    items.push({ name, price });
                }
            }
            return items;
        }

        // Show OCR preview modal
        function showOcrPreview(extractedItems) {
            pendingOcrItems = extractedItems.map((item, idx) => ({
                ...item,
                selected: true,
                id: idx
            }));

            renderOcrPreview();
            document.getElementById('previewModal').classList.add('show');
        }

        // Render OCR preview items
        function renderOcrPreview() {
            const container = document.getElementById('previewItems');
            const selectedCount = pendingOcrItems.filter(i => i.selected).length;
            document.getElementById('previewCount').textContent = `${selectedCount} selected`;

            container.innerHTML = pendingOcrItems.map(item => `
                <div class="preview-item">
                    <input type="checkbox" ${item.selected ? 'checked' : ''}
                        onchange="toggleOcrItem(${item.id})">
                    <span class="preview-item-name">${item.name}</span>
                    <span class="preview-item-price">S$ ${item.price.toFixed(2)}</span>
                </div>
            `).join('');
        }

        // Toggle OCR item selection
        function toggleOcrItem(id) {
            const item = pendingOcrItems.find(i => i.id === id);
            if (item) {
                item.selected = !item.selected;
                renderOcrPreview();
            }
        }

        // Close preview modal
        function closePreview() {
            document.getElementById('previewModal').classList.remove('show');
            pendingOcrItems = [];
        }

        // Confirm and add selected OCR items
        function confirmPreview() {
            const selected = pendingOcrItems.filter(i => i.selected);
            if (selected.length > 0) {
                saveStateForUndo(); // Save state before change
            }
            selected.forEach(item => {
                items.push({
                    id: itemIdCounter++,
                    name: item.name,
                    price: item.price,
                    people: [...people]
                });
            });

            renderItems();
            calculate();
            syncSessionToFirebase(); // Real-time sync
            closePreview();
            showToast(`Added ${selected.length} items`);
        }

        // Manual entry fallback - show raw API result for user to copy
        function showRawOcrText(text) {
            const cleanText = text.replace(/\\n/g, '\n').replace(/\n+/g, '\n').trim();
            alert('API Result (copy items manually):\n\n' + cleanText);
        }

        // Initialize
        init();
    </script>
</body>
</html>
