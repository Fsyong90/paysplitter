<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PayNow Lunch Splitter</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .app-container {
            max-width: 600px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            color: white;
            margin-bottom: 20px;
        }
        
        .header h1 {
            font-size: 28px;
            margin-bottom: 5px;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 14px;
        }
        
        .card {
            background: white;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }
        
        .card-title {
            font-size: 16px;
            font-weight: 700;
            color: #333;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .card-title .icon {
            font-size: 20px;
        }
        
        /* People Section */
        .people-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 12px;
        }
        
        .person-tag {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 10px 14px;
            background: linear-gradient(135deg, #7B2D8E, #E91E8C);
            color: white;
            border-radius: 20px;
            font-size: 15px;
            font-weight: 500;
            min-height: 44px;
        }

        .person-tag .remove {
            cursor: pointer;
            opacity: 0.8;
            font-size: 20px;
            padding: 4px;
            min-width: 28px;
            min-height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .person-tag .remove:hover {
            opacity: 1;
        }
        
        .add-person-row {
            display: flex;
            gap: 8px;
        }
        
        .add-person-input {
            flex: 1;
            padding: 12px 14px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 16px;
            outline: none;
            min-height: 48px;
        }

        .add-person-input:focus {
            border-color: #7B2D8E;
        }

        .add-btn {
            padding: 12px 20px;
            background: #7B2D8E;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            min-height: 48px;
            min-width: 80px;
        }

        .add-btn:hover {
            background: #5a1f6a;
        }
        
        /* Items Section */
        .item-row {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 14px;
            margin-bottom: 10px;
            position: relative;
            transition: transform 0.2s, opacity 0.2s;
        }

        .item-row.swiping {
            transform: translateX(-80px);
        }

        .item-row.removing {
            transform: translateX(-100%);
            opacity: 0;
        }

        .item-main {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
            align-items: center;
        }

        .item-name {
            flex: 2;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 16px;
            outline: none;
            background: white;
            min-height: 48px;
        }

        .item-name:focus {
            border-color: #7B2D8E;
        }

        .item-price {
            width: 90px;
            padding: 12px 8px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 16px;
            outline: none;
            text-align: right;
            background: white;
            min-height: 48px;
        }

        .item-price:focus {
            border-color: #7B2D8E;
        }

        .remove-item-btn {
            width: 48px;
            height: 48px;
            border: none;
            background: #fee;
            color: #e74c3c;
            border-radius: 8px;
            cursor: pointer;
            font-size: 22px;
            flex-shrink: 0;
        }

        .remove-item-btn:hover, .remove-item-btn:active {
            background: #e74c3c;
            color: white;
        }
        
        .item-people {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }
        
        .item-people-label {
            font-size: 12px;
            color: #888;
            width: 100%;
            margin-bottom: 4px;
        }
        
        .person-checkbox {
            display: none;
        }
        
        .person-label {
            padding: 10px 14px;
            background: #e9ecef;
            border-radius: 20px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            user-select: none;
            min-height: 40px;
            display: inline-flex;
            align-items: center;
        }

        .person-checkbox:checked + .person-label {
            background: linear-gradient(135deg, #7B2D8E, #E91E8C);
            color: white;
        }
        
        .add-item-btn {
            width: 100%;
            padding: 12px;
            border: 2px dashed #ccc;
            background: transparent;
            border-radius: 8px;
            color: #666;
            font-size: 14px;
            cursor: pointer;
        }
        
        .add-item-btn:hover {
            border-color: #7B2D8E;
            color: #7B2D8E;
        }
        
        /* Options */
        .options-grid {
            display: grid;
            gap: 12px;
        }
        
        .option-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 10px;
        }
        
        .option-label span:first-child {
            font-weight: 600;
            color: #333;
        }
        
        .option-label span:last-child {
            display: block;
            font-size: 11px;
            color: #888;
            margin-top: 2px;
        }
        
        .option-controls {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .rate-input {
            width: 55px;
            padding: 8px;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            font-size: 14px;
            text-align: center;
            outline: none;
        }
        
        .rate-input:focus {
            border-color: #7B2D8E;
        }
        
        .switch {
            position: relative;
            width: 46px;
            height: 26px;
        }
        
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: 0.3s;
            border-radius: 26px;
        }
        
        .slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
        }
        
        input:checked + .slider {
            background: linear-gradient(135deg, #7B2D8E, #E91E8C);
        }
        
        input:checked + .slider:before {
            transform: translateX(20px);
        }
        
        .discount-input {
            width: 70px;
            padding: 8px;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            font-size: 14px;
            text-align: right;
            outline: none;
        }
        
        .discount-type {
            padding: 8px;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            font-size: 14px;
            outline: none;
            background: white;
        }
        
        /* Summary */
        .bill-summary {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
        }
        
        .summary-row {
            display: flex;
            justify-content: space-between;
            padding: 6px 0;
            font-size: 14px;
            color: #666;
        }
        
        .summary-row.total {
            font-size: 18px;
            font-weight: 700;
            color: #333;
            border-top: 2px solid #ddd;
            padding-top: 12px;
            margin-top: 8px;
        }

        .summary-row.expected-total {
            font-size: 13px;
            color: #666;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px dashed #ddd;
            align-items: center;
        }

        .expected-input-wrap {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .expected-input {
            width: 80px;
            padding: 6px 8px;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            font-size: 14px;
            text-align: right;
            outline: none;
        }

        .expected-input:focus {
            border-color: #7B2D8E;
        }

        .total-match {
            text-align: center;
            padding: 12px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            margin-top: 12px;
            display: none;
        }

        .total-match.match {
            display: block;
            background: #d4edda;
            color: #155724;
            border: 2px solid #28a745;
        }

        .total-match.mismatch {
            display: block;
            background: #f8d7da;
            color: #721c24;
            border: 2px solid #dc3545;
        }

        .total-match .match-icon {
            font-size: 20px;
            display: block;
            margin-bottom: 4px;
        }

        .total-match .match-hint {
            font-size: 11px;
            font-weight: 400;
            opacity: 0.8;
            margin-top: 4px;
        }

        .negative {
            color: #28a745;
        }
        
        /* Person Breakdown */
        .person-breakdown {
            border: 2px solid #e9ecef;
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 12px;
        }
        
        .person-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px 16px;
            background: linear-gradient(135deg, #7B2D8E, #E91E8C);
            color: white;
            cursor: pointer;
        }
        
        .person-name {
            font-weight: 600;
            font-size: 16px;
        }
        
        .person-total {
            font-weight: 700;
            font-size: 18px;
        }
        
        .person-details {
            padding: 12px 16px;
            background: white;
            display: none;
        }
        
        .person-details.show {
            display: block;
        }
        
        .detail-row {
            display: flex;
            justify-content: space-between;
            padding: 4px 0;
            font-size: 13px;
            color: #666;
        }
        
        .detail-row.item {
            color: #333;
        }
        
        .detail-row .shared {
            font-size: 11px;
            color: #888;
        }
        
        .generate-person-btn {
            width: 100%;
            margin-top: 12px;
            padding: 12px;
            background: linear-gradient(135deg, #7B2D8E, #E91E8C);
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
        }
        
        .generate-person-btn:hover {
            opacity: 0.9;
        }
        
        /* QR Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 20px;
        }
        
        .modal-overlay.show {
            display: flex;
        }
        
        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            text-align: center;
            max-width: 350px;
            width: 100%;
        }
        
        .modal-title {
            font-size: 20px;
            font-weight: 700;
            color: #333;
            margin-bottom: 8px;
        }
        
        .modal-subtitle {
            font-size: 14px;
            color: #888;
            margin-bottom: 20px;
        }
        
        .qr-wrapper {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            display: inline-block;
            margin-bottom: 16px;
        }
        
        #qrcode {
            display: flex;
            justify-content: center;
        }
        
        .qr-amount {
            font-size: 32px;
            font-weight: 700;
            color: #7B2D8E;
        }
        
        .qr-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .qr-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
        }
        
        .qr-btn.download {
            background: #28a745;
            color: white;
        }
        
        .qr-btn.close {
            background: #6c757d;
            color: white;
        }
        
        .phone-info {
            font-size: 12px;
            color: #888;
            margin-top: 16px;
        }
        
        .no-items {
            text-align: center;
            padding: 20px;
            color: #888;
            font-style: italic;
        }

        .shared-items-note {
            font-size: 11px;
            color: #888;
            margin-top: 4px;
            font-style: italic;
        }

        /* Saved Team Section */
        .team-section {
            margin-bottom: 12px;
        }

        .team-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .team-label {
            font-size: 12px;
            color: #666;
            font-weight: 500;
        }

        .team-actions {
            display: flex;
            gap: 8px;
        }

        .team-btn {
            padding: 4px 10px;
            font-size: 11px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            color: #666;
        }

        .team-btn:hover {
            background: #f0f0f0;
        }

        .team-btn.active {
            background: #7B2D8E;
            color: white;
            border-color: #7B2D8E;
        }

        .saved-team-list {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-bottom: 12px;
        }

        .saved-person {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 6px 10px;
            background: #f0f0f0;
            border-radius: 16px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
        }

        .saved-person.selected {
            background: linear-gradient(135deg, #7B2D8E, #E91E8C);
            color: white;
        }

        .saved-person .delete-saved {
            margin-left: 4px;
            opacity: 0.6;
            font-size: 14px;
        }

        .saved-person .delete-saved:hover {
            opacity: 1;
        }

        /* History Section */
        .history-card {
            background: white;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }

        .history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
        }

        .history-item:hover {
            background: #e9ecef;
        }

        .history-info {
            flex: 1;
        }

        .history-date {
            font-size: 12px;
            color: #888;
        }

        .history-desc {
            font-weight: 600;
            color: #333;
        }

        .history-people {
            font-size: 12px;
            color: #666;
        }

        .history-total {
            font-weight: 700;
            color: #7B2D8E;
            font-size: 16px;
        }

        .history-delete {
            margin-left: 12px;
            padding: 6px 10px;
            background: #fee;
            color: #e74c3c;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
        }

        .history-delete:hover {
            background: #e74c3c;
            color: white;
        }

        /* Share Buttons */
        .share-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #eee;
        }

        .share-btn {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .share-btn.whatsapp {
            background: #25D366;
            color: white;
        }

        .share-btn.copy-link {
            background: #6c757d;
            color: white;
        }

        .share-btn.save-history {
            background: #007bff;
            color: white;
        }

        /* Rounding Option */
        .rounding-select {
            padding: 8px;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            font-size: 14px;
            outline: none;
            background: white;
        }

        /* Toast notification */
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            z-index: 2000;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .toast.show {
            opacity: 1;
        }

        /* Tab navigation */
        .tab-nav {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }

        .tab-btn {
            flex: 1;
            padding: 12px;
            border: none;
            background: rgba(255,255,255,0.2);
            color: white;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
        }

        .tab-btn.active {
            background: white;
            color: #7B2D8E;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Receipt Scan Section - Modern Design */
        .ocr-section {
            margin-bottom: 16px;
        }

        .ocr-upload {
            width: 100%;
            padding: 24px 20px;
            border: none;
            border-radius: 16px;
            text-align: center;
            cursor: pointer;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .ocr-upload:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .ocr-upload:active {
            transform: translateY(0);
        }

        .ocr-upload .upload-icon {
            font-size: 32px;
            margin-bottom: 4px;
        }

        .ocr-upload .upload-title {
            font-size: 16px;
            font-weight: 700;
        }

        .ocr-upload .upload-subtitle {
            font-size: 12px;
            opacity: 0.85;
        }

        .ocr-upload .ai-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            background: rgba(255,255,255,0.2);
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 11px;
            margin-top: 4px;
        }

        .ocr-upload input {
            display: none;
        }

        .ocr-status {
            margin-top: 10px;
            padding: 10px;
            background: #e3f2fd;
            border-radius: 6px;
            font-size: 13px;
            color: #1565c0;
            display: none;
        }

        .ocr-status.show {
            display: block;
        }

        .ocr-status.error {
            background: #ffebee;
            color: #c62828;
        }

        /* Payment tracking */
        .person-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px 16px;
            background: linear-gradient(135deg, #7B2D8E, #E91E8C);
            color: white;
            cursor: pointer;
            min-height: 56px;
        }

        .person-header.paid {
            background: linear-gradient(135deg, #1e8449, #27ae60);
        }

        .paid-btn {
            padding: 8px 14px;
            background: rgba(255,255,255,0.2);
            border: 2px solid rgba(255,255,255,0.5);
            color: white;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            margin-left: 10px;
            min-height: 40px;
            transition: all 0.2s;
        }

        .paid-btn:hover, .paid-btn:active {
            background: rgba(255,255,255,0.3);
        }

        .paid-btn.is-paid {
            background: white;
            color: #27ae60;
            border-color: white;
        }

        /* Receipt Preview Modal */
        .preview-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            padding: 20px;
            overflow-y: auto;
        }

        .preview-modal.show {
            display: block;
        }

        .preview-content {
            background: white;
            border-radius: 16px;
            padding: 20px;
            max-width: 500px;
            margin: 20px auto;
        }

        .preview-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .preview-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .preview-item input[type="checkbox"] {
            width: 24px;
            height: 24px;
            cursor: pointer;
        }

        .preview-item-name {
            flex: 1;
            font-size: 15px;
        }

        .preview-item-price {
            font-weight: 600;
            color: #7B2D8E;
        }

        .preview-actions {
            display: flex;
            gap: 10px;
            margin-top: 16px;
        }

        .preview-btn {
            flex: 1;
            padding: 14px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            min-height: 50px;
        }

        .preview-btn.confirm {
            background: linear-gradient(135deg, #7B2D8E, #E91E8C);
            color: white;
        }

        .preview-btn.cancel {
            background: #e9ecef;
            color: #666;
        }

        /* Saved team larger touch targets */
        .saved-person {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 10px 14px;
            background: #f0f0f0;
            border-radius: 20px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
            min-height: 44px;
        }

        .saved-person .delete-saved {
            margin-left: 6px;
            opacity: 0.6;
            font-size: 18px;
            padding: 4px;
            min-width: 28px;
            min-height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Team Code Section */
        .team-code-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 16px;
        }

        .team-code-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .team-code-label {
            font-size: 12px;
            color: #666;
            font-weight: 500;
        }

        .team-code-input-row {
            display: flex;
            gap: 8px;
        }

        .team-code-input {
            flex: 1;
            padding: 10px 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            text-transform: uppercase;
            outline: none;
        }

        .team-code-input:focus {
            border-color: #7B2D8E;
        }

        .team-code-btn {
            padding: 10px 16px;
            background: #7B2D8E;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
        }

        .team-code-btn:hover {
            background: #5a1f6a;
        }

        .team-code-btn.leave {
            background: #e74c3c;
        }

        .team-code-status {
            margin-top: 8px;
            font-size: 12px;
            color: #28a745;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .team-code-status.syncing {
            color: #f39c12;
        }

        .sync-indicator {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            background: #d4edda;
            color: #155724;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
        }

        .sync-indicator.offline {
            background: #f8d7da;
            color: #721c24;
        }

        /* Quick Split Buttons */
        .quick-split-section {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }

        .quick-split-btn {
            flex: 1;
            min-width: 120px;
            padding: 12px 16px;
            border: 2px solid #e9ecef;
            background: white;
            border-radius: 10px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            transition: all 0.2s;
        }

        .quick-split-btn:hover {
            border-color: #7B2D8E;
            background: #f8f4fa;
        }

        .quick-split-btn:active {
            transform: scale(0.98);
        }

        .quick-split-btn .icon {
            font-size: 20px;
        }

        .quick-split-btn .label {
            color: #333;
        }

        .quick-split-btn .desc {
            font-size: 10px;
            color: #888;
            font-weight: 400;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="header">
            <h1>üçú PayNow Splitter</h1>
            <p>Each person pays for their own items</p>
        </div>

        <!-- Tab Navigation -->
        <div class="tab-nav">
            <button class="tab-btn active" onclick="switchTab('split')">üßæ Split Bill</button>
            <button class="tab-btn" onclick="switchTab('history')">üìã History</button>
        </div>

        <!-- Split Bill Tab -->
        <div class="tab-content active" id="tab-split">

        <!-- Team Code -->
        <div class="card">
            <div class="card-title"><span class="icon">üîó</span> Team Sync</div>
            <div class="team-code-section" id="teamCodeSection">
                <div class="team-code-header">
                    <span class="team-code-label">Enter a team code to sync with your teammates</span>
                </div>
                <div class="team-code-input-row" id="teamCodeInputRow">
                    <input type="text" class="team-code-input" id="teamCodeInput" placeholder="e.g., LUNCH2024" maxlength="20">
                    <button class="team-code-btn" onclick="joinTeam()">Join</button>
                </div>
                <div class="team-code-status" id="teamCodeStatus" style="display: none;"></div>
            </div>
        </div>

        <!-- People -->
        <div class="card">
            <div class="card-title"><span class="icon">üë•</span> Who's Eating?</div>

            <!-- Saved Team -->
            <div class="team-section" id="teamSection">
                <div class="team-header">
                    <span class="team-label">Your Team (click to add)</span>
                    <div class="team-actions">
                        <button class="team-btn" onclick="selectAllTeam()">All</button>
                        <button class="team-btn" onclick="selectNoneTeam()">None</button>
                    </div>
                </div>
                <div class="saved-team-list" id="savedTeamList"></div>
            </div>

            <div class="people-list" id="peopleList"></div>
            <div class="add-person-row">
                <input type="text" class="add-person-input" id="newPersonName" placeholder="Enter name (saves to team)" onkeypress="if(event.key==='Enter')addPerson()">
                <button class="add-btn" onclick="addPerson()">+ Add</button>
            </div>
        </div>
        
        <!-- Items -->
        <div class="card">
            <div class="card-title"><span class="icon">üçΩÔ∏è</span> What's Ordered?</div>

            <!-- Quick Split Buttons -->
            <div class="quick-split-section" id="quickSplitSection">
                <button class="quick-split-btn" onclick="splitAllEqually()">
                    <span class="icon">üë•</span>
                    <span class="label">Split Equally</span>
                    <span class="desc">Everyone shares all</span>
                </button>
                <button class="quick-split-btn" onclick="splitEachOwn()">
                    <span class="icon">üôã</span>
                    <span class="label">Each Own</span>
                    <span class="desc">Assign per person</span>
                </button>
                <button class="quick-split-btn" onclick="clearAllAssignments()">
                    <span class="icon">üîÑ</span>
                    <span class="label">Clear All</span>
                    <span class="desc">Reset assignments</span>
                </button>
            </div>

            <!-- AI Receipt Scanner -->
            <div class="ocr-section">
                <label class="ocr-upload" id="ocrUpload">
                    <input type="file" accept="image/*" onchange="handleReceiptUpload(event)">
                    <span class="upload-icon">üì∏</span>
                    <span class="upload-title">Scan Receipt with AI</span>
                    <span class="upload-subtitle">Take a photo or upload an image</span>
                    <span class="ai-badge">‚ú® Powered by AI</span>
                </label>
                <div class="ocr-status" id="ocrStatus"></div>
            </div>

            <div id="itemsList"></div>
            <button class="add-item-btn" onclick="addItem()">+ Add Item</button>
        </div>
        
        <!-- Options -->
        <div class="card">
            <div class="card-title"><span class="icon">‚öôÔ∏è</span> Bill Options</div>
            <div class="options-grid">
                <div class="option-row">
                    <div class="option-label">
                        <span>Service Charge</span>
                        <span>Before GST</span>
                    </div>
                    <div class="option-controls">
                        <input type="number" class="rate-input" id="serviceRate" value="10" min="0" max="100" step="0.5" oninput="calculate()">
                        <span>%</span>
                        <label class="switch">
                            <input type="checkbox" id="hasService" onchange="calculate()">
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>
                
                <div class="option-row">
                    <div class="option-label">
                        <span>Discount</span>
                        <span>Before GST</span>
                    </div>
                    <div class="option-controls">
                        <input type="number" class="discount-input" id="discountValue" placeholder="0" step="0.01" oninput="calculate()">
                        <select class="discount-type" id="discountType" onchange="calculate()">
                            <option value="amount">S$</option>
                            <option value="percent">%</option>
                        </select>
                    </div>
                </div>
                
                <div class="option-row">
                    <div class="option-label">
                        <span>GST</span>
                        <span>After svc & discount</span>
                    </div>
                    <div class="option-controls">
                        <input type="number" class="rate-input" id="gstRate" value="9" min="0" max="100" step="0.5" oninput="calculate()">
                        <span>%</span>
                        <label class="switch">
                            <input type="checkbox" id="hasGST" checked onchange="calculate()">
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>

                <div class="option-row">
                    <div class="option-label">
                        <span>Rounding</span>
                        <span>Per person amount</span>
                    </div>
                    <div class="option-controls">
                        <select class="rounding-select" id="roundingType" onchange="calculate()">
                            <option value="none">Exact</option>
                            <option value="0.10">$0.10</option>
                            <option value="0.50">$0.50</option>
                            <option value="1.00">$1.00</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Summary -->
        <div class="card">
            <div class="card-title"><span class="icon">üßæ</span> Bill Summary</div>
            <div class="bill-summary">
                <div class="summary-row">
                    <span>Subtotal</span>
                    <span id="subtotalDisplay">S$ 0.00</span>
                </div>
                <div class="summary-row" id="discountRow" style="display: none;">
                    <span>Discount</span>
                    <span class="negative" id="discountDisplay">-S$ 0.00</span>
                </div>
                <div class="summary-row" id="subtotalAfterDiscountRow" style="display: none;">
                    <span>After Discount</span>
                    <span id="subtotalAfterDiscountDisplay">S$ 0.00</span>
                </div>
                <div class="summary-row" id="serviceRow" style="display: none;">
                    <span>Service (<span id="svcPct">10</span>%)</span>
                    <span id="serviceDisplay">S$ 0.00</span>
                </div>
                <div class="summary-row" id="gstRow">
                    <span>GST (<span id="gstPct">9</span>%)</span>
                    <span id="gstDisplay">S$ 0.00</span>
                </div>
                <div class="summary-row total">
                    <span>Total</span>
                    <span id="totalDisplay">S$ 0.00</span>
                </div>
                <div class="summary-row expected-total">
                    <span>Expected Total (from receipt)</span>
                    <div class="expected-input-wrap">
                        <span>S$</span>
                        <input type="number" class="expected-input" id="expectedTotal" placeholder="0.00" step="0.01" oninput="checkTotalMatch()">
                    </div>
                </div>
                <div class="total-match" id="totalMatch"></div>
            </div>
            
            <div class="card-title"><span class="icon">üí∞</span> Each Person Pays</div>
            <div id="breakdownList">
                <div class="no-items">Add people and items to see breakdown</div>
            </div>

            <!-- Share Actions -->
            <div class="share-actions" id="shareActions" style="display: none;">
                <button class="share-btn whatsapp" onclick="shareWhatsApp()">üì± WhatsApp</button>
                <button class="share-btn copy-link" onclick="copyShareLink()">üîó Copy Link</button>
                <button class="share-btn save-history" onclick="saveToHistory()">üíæ Save</button>
            </div>
        </div>

        </div><!-- End Split Tab -->

        <!-- History Tab -->
        <div class="tab-content" id="tab-history">
            <div class="card">
                <div class="card-title"><span class="icon">üìã</span> Split History</div>
                <div id="historyList">
                    <div class="no-items">No saved splits yet</div>
                </div>
                <button class="add-item-btn" onclick="clearHistory()" style="margin-top: 12px; border-color: #e74c3c; color: #e74c3c;">üóëÔ∏è Clear All History</button>
            </div>
        </div>

    </div>
    
    <!-- QR Modal -->
    <div class="modal-overlay" id="qrModal" onclick="closeModal(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-title" id="modalName">Person Name</div>
            <div class="modal-subtitle">Scan to pay your share</div>
            <div class="qr-wrapper">
                <div id="qrcode"></div>
            </div>
            <div class="qr-amount" id="modalAmount">S$ 0.00</div>
            <div class="qr-actions">
                <button class="qr-btn download" onclick="downloadQR()">üì• Download</button>
                <button class="qr-btn close" onclick="closeModal()">‚úï Close</button>
            </div>
            <div class="phone-info">PayNow to +65 8339 9525</div>
        </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <!-- Receipt Preview Modal -->
    <div class="preview-modal" id="previewModal">
        <div class="preview-content">
            <div class="preview-title">
                <span>üì∑ Scanned Items</span>
                <span id="previewCount">0 items</span>
            </div>
            <div id="previewItems"></div>
            <div class="preview-actions">
                <button class="preview-btn cancel" onclick="closePreview()">Cancel</button>
                <button class="preview-btn confirm" onclick="confirmPreview()">Add Selected</button>
            </div>
        </div>
    </div>

    <script>
        let people = [];
        let items = [];
        let itemIdCounter = 0;
        let qrcode = null;
        let savedTeam = [];
        let splitHistory = [];
        let paidStatus = {}; // Track who has paid
        let pendingOcrItems = []; // Items pending from receipt scan

        // LocalStorage keys
        const TEAM_KEY = 'paynow_team';
        const HISTORY_KEY = 'paynow_history';
        const TEAM_CODE_KEY = 'paynow_team_code';

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyA8bj45ygxLjMiWH-iNdqzNJeXmU_mG5dY",
            authDomain: "paysplitter-16bd6.firebaseapp.com",
            projectId: "paysplitter-16bd6",
            storageBucket: "paysplitter-16bd6.firebasestorage.app",
            messagingSenderId: "906740214966",
            appId: "1:906740214966:web:139c8b63ee599484474a17"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Team code for syncing
        let currentTeamCode = null;
        let unsubscribeTeam = null;
        let unsubscribeHistory = null;

        // Initialize
        function init() {
            loadSavedTeam();
            loadHistory();
            loadTeamCode();
            checkUrlParams();
            if (people.length === 0) {
                addItem();
            }
            renderSavedTeam();
            renderHistory();
            renderTeamCodeUI();
        }

        // Load team code from localStorage and connect
        function loadTeamCode() {
            const savedCode = localStorage.getItem(TEAM_CODE_KEY);
            if (savedCode) {
                currentTeamCode = savedCode;
                connectToTeam(savedCode);
            }
        }

        // Join a team by code
        async function joinTeam() {
            const input = document.getElementById('teamCodeInput');
            const code = input.value.trim().toUpperCase();

            if (!code || code.length < 3) {
                showToast('Please enter a valid team code (min 3 characters)');
                return;
            }

            try {
                // Save to localStorage
                localStorage.setItem(TEAM_CODE_KEY, code);
                currentTeamCode = code;

                // Create team doc if doesn't exist
                const teamRef = db.collection('teams').doc(code);
                const teamDoc = await teamRef.get();

                if (!teamDoc.exists) {
                    // Create new team with current data
                    await teamRef.set({
                        teammates: savedTeam,
                        history: splitHistory,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    showToast(`Created team: ${code}`);
                } else {
                    showToast(`Joined team: ${code}`);
                }

                // Connect to real-time updates
                connectToTeam(code);
                renderTeamCodeUI();

            } catch (e) {
                console.error('Error joining team:', e);
                showToast('Error connecting to team');
            }
        }

        // Leave current team
        function leaveTeam() {
            if (unsubscribeTeam) unsubscribeTeam();
            if (unsubscribeHistory) unsubscribeHistory();

            localStorage.removeItem(TEAM_CODE_KEY);
            currentTeamCode = null;

            renderTeamCodeUI();
            showToast('Left team - now using local storage only');
        }

        // Connect to team for real-time updates
        function connectToTeam(code) {
            // Unsubscribe from previous listeners
            if (unsubscribeTeam) unsubscribeTeam();
            if (unsubscribeHistory) unsubscribeHistory();

            const teamRef = db.collection('teams').doc(code);

            // Listen for teammate changes
            unsubscribeTeam = teamRef.onSnapshot((doc) => {
                if (doc.exists) {
                    const data = doc.data();
                    if (data.teammates) {
                        savedTeam = data.teammates;
                        localStorage.setItem(TEAM_KEY, JSON.stringify(savedTeam));
                        renderSavedTeam();
                    }
                    if (data.history) {
                        splitHistory = data.history;
                        localStorage.setItem(HISTORY_KEY, JSON.stringify(splitHistory));
                        renderHistory();
                    }
                    updateSyncStatus('synced');
                }
            }, (error) => {
                console.error('Firestore error:', error);
                updateSyncStatus('offline');
            });
        }

        // Update sync status indicator
        function updateSyncStatus(status) {
            const statusEl = document.getElementById('teamCodeStatus');
            if (status === 'synced') {
                statusEl.innerHTML = '<span class="sync-indicator">‚úì Synced</span> Team data is shared with teammates';
            } else if (status === 'offline') {
                statusEl.innerHTML = '<span class="sync-indicator offline">‚ö† Offline</span> Using local data';
            }
        }

        // Render team code UI based on connection state
        function renderTeamCodeUI() {
            const inputRow = document.getElementById('teamCodeInputRow');
            const status = document.getElementById('teamCodeStatus');
            const label = document.querySelector('.team-code-label');

            if (currentTeamCode) {
                inputRow.innerHTML = `
                    <span style="flex:1; font-weight: 600; color: #7B2D8E; font-size: 16px;">üì° ${currentTeamCode}</span>
                    <button class="team-code-btn leave" onclick="leaveTeam()">Leave</button>
                `;
                label.textContent = 'Connected to team:';
                status.style.display = 'flex';
            } else {
                inputRow.innerHTML = `
                    <input type="text" class="team-code-input" id="teamCodeInput" placeholder="e.g., LUNCH2024" maxlength="20">
                    <button class="team-code-btn" onclick="joinTeam()">Join</button>
                `;
                label.textContent = 'Enter a team code to sync with your teammates';
                status.style.display = 'none';
            }
        }

        // Override saveTeam to sync to Firebase
        async function saveTeamToFirebase() {
            if (!currentTeamCode) return;

            try {
                await db.collection('teams').doc(currentTeamCode).update({
                    teammates: savedTeam
                });
            } catch (e) {
                console.error('Error saving team to Firebase:', e);
            }
        }

        // Override saveHistory to sync to Firebase
        async function saveHistoryToFirebase() {
            if (!currentTeamCode) return;

            try {
                await db.collection('teams').doc(currentTeamCode).update({
                    history: splitHistory
                });
            } catch (e) {
                console.error('Error saving history to Firebase:', e);
            }
        }

        // Load saved team from localStorage
        function loadSavedTeam() {
            try {
                const saved = localStorage.getItem(TEAM_KEY);
                if (saved) {
                    savedTeam = JSON.parse(saved);
                }
            } catch (e) {
                console.error('Error loading team:', e);
            }
        }

        // Save team to localStorage and Firebase
        function saveTeam() {
            try {
                localStorage.setItem(TEAM_KEY, JSON.stringify(savedTeam));
                saveTeamToFirebase(); // Sync to Firebase
            } catch (e) {
                console.error('Error saving team:', e);
            }
        }

        // Load history from localStorage
        function loadHistory() {
            try {
                const saved = localStorage.getItem(HISTORY_KEY);
                if (saved) {
                    splitHistory = JSON.parse(saved);
                }
            } catch (e) {
                console.error('Error loading history:', e);
            }
        }

        // Save history to localStorage and Firebase
        function saveHistoryToStorage() {
            try {
                localStorage.setItem(HISTORY_KEY, JSON.stringify(splitHistory));
                saveHistoryToFirebase(); // Sync to Firebase
            } catch (e) {
                console.error('Error saving history:', e);
            }
        }

        // Render saved team
        function renderSavedTeam() {
            const list = document.getElementById('savedTeamList');
            if (savedTeam.length === 0) {
                list.innerHTML = '<span style="font-size: 12px; color: #888;">Add people to build your team</span>';
                return;
            }
            list.innerHTML = savedTeam.map(name => `
                <div class="saved-person ${people.includes(name) ? 'selected' : ''}" onclick="toggleSavedPerson('${name}')">
                    ${name}
                    <span class="delete-saved" onclick="event.stopPropagation(); deleteSavedPerson('${name}')">√ó</span>
                </div>
            `).join('');
        }

        // Toggle saved person in/out of current session
        function toggleSavedPerson(name) {
            if (people.includes(name)) {
                removePerson(name);
            } else {
                addPerson(name);
            }
            renderSavedTeam();
        }

        // Delete from saved team
        function deleteSavedPerson(name) {
            savedTeam = savedTeam.filter(n => n !== name);
            saveTeam();
            renderSavedTeam();
            showToast(`Removed ${name} from team`);
        }

        // ==================== QUICK SPLIT FUNCTIONS ====================

        // Split all items equally among everyone
        function splitAllEqually() {
            if (people.length === 0) {
                showToast('Add people first!');
                return;
            }
            if (items.length === 0) {
                showToast('Add items first!');
                return;
            }

            items.forEach(item => {
                item.people = [...people]; // Assign everyone to every item
            });

            renderItems();
            calculate();
            showToast('All items split equally!');
        }

        // Each person gets their own items (for manual assignment)
        function splitEachOwn() {
            if (people.length === 0) {
                showToast('Add people first!');
                return;
            }

            // Clear all assignments so user can manually assign
            items.forEach(item => {
                item.people = [];
            });

            renderItems();
            calculate();
            showToast('Cleared! Now assign each item to its owner');
        }

        // Clear all item assignments
        function clearAllAssignments() {
            items.forEach(item => {
                item.people = [];
            });

            renderItems();
            calculate();
            showToast('All assignments cleared');
        }

        // Select all team members
        function selectAllTeam() {
            savedTeam.forEach(name => {
                if (!people.includes(name)) {
                    people.push(name);
                    items.forEach(item => {
                        if (!item.people.includes(name)) {
                            item.people.push(name);
                        }
                    });
                }
            });
            renderPeople();
            renderItems();
            renderSavedTeam();
            calculate();
        }

        // Deselect all team members
        function selectNoneTeam() {
            people = [];
            items.forEach(item => item.people = []);
            renderPeople();
            renderItems();
            renderSavedTeam();
            calculate();
        }

        // Tab switching
        function switchTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.querySelector(`[onclick="switchTab('${tab}')"]`).classList.add('active');
            document.getElementById(`tab-${tab}`).classList.add('active');
        }

        // Show toast notification
        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 2500);
        }
        
        function addPerson(name) {
            const inputName = name || document.getElementById('newPersonName').value.trim();
            if (!inputName) return;

            if (!people.includes(inputName)) {
                people.push(inputName);
                // Also save to team if new
                if (!savedTeam.includes(inputName)) {
                    savedTeam.push(inputName);
                    saveTeam();
                }
                renderPeople();
                renderItems();
                renderSavedTeam();
                calculate();
            }

            document.getElementById('newPersonName').value = '';
        }
        
        function removePerson(name) {
            people = people.filter(p => p !== name);
            // Remove from all items
            items.forEach(item => {
                item.people = item.people.filter(p => p !== name);
            });
            renderPeople();
            renderItems();
            calculate();
        }
        
        function renderPeople() {
            const list = document.getElementById('peopleList');
            list.innerHTML = people.map(p => `
                <div class="person-tag">
                    ${p}
                    <span class="remove" onclick="removePerson('${p}')">√ó</span>
                </div>
            `).join('');
        }
        
        function addItem() {
            items.push({
                id: itemIdCounter++,
                name: '',
                price: 0,
                people: [...people] // Default: everyone shares
            });
            renderItems();
        }
        
        function removeItem(id) {
            items = items.filter(i => i.id !== id);
            renderItems();
            calculate();
        }
        
        function updateItem(id, field, value) {
            const item = items.find(i => i.id === id);
            if (item) {
                item[field] = field === 'price' ? (parseFloat(value) || 0) : value;
                calculate();
            }
        }
        
        function togglePerson(itemId, person) {
            const item = items.find(i => i.id === itemId);
            if (item) {
                if (item.people.includes(person)) {
                    item.people = item.people.filter(p => p !== person);
                } else {
                    item.people.push(person);
                }
                renderItems();
                calculate();
            }
        }
        
        function renderItems() {
            const list = document.getElementById('itemsList');
            
            if (items.length === 0) {
                list.innerHTML = '<div class="no-items">No items added yet</div>';
                return;
            }
            
            list.innerHTML = items.map(item => `
                <div class="item-row">
                    <div class="item-main">
                        <input type="text" class="item-name" placeholder="Item name" 
                            value="${item.name}" 
                            oninput="updateItem(${item.id}, 'name', this.value)">
                        <input type="number" class="item-price" placeholder="0.00" step="0.01"
                            value="${item.price || ''}"
                            oninput="updateItem(${item.id}, 'price', this.value)">
                        <button class="remove-item-btn" onclick="removeItem(${item.id})">√ó</button>
                    </div>
                    <div class="item-people">
                        <div class="item-people-label">Who's sharing this?</div>
                        ${people.map(p => `
                            <input type="checkbox" class="person-checkbox" 
                                id="item${item.id}_${p}" 
                                ${item.people.includes(p) ? 'checked' : ''}
                                onchange="togglePerson(${item.id}, '${p}')">
                            <label class="person-label" for="item${item.id}_${p}">${p}</label>
                        `).join('')}
                    </div>
                </div>
            `).join('');
        }
        
        function calculate() {
            // Calculate subtotal
            let subtotal = 0;
            items.forEach(item => {
                subtotal += item.price || 0;
            });

            // 1. Discount FIRST (applied to subtotal)
            const discountValue = parseFloat(document.getElementById('discountValue').value) || 0;
            const discountType = document.getElementById('discountType').value;
            let discountAmt = 0;
            if (discountType === 'percent') {
                discountAmt = subtotal * (discountValue / 100);
            } else {
                discountAmt = discountValue;
            }

            // Subtotal after discount
            const subtotalAfterDiscount = subtotal - discountAmt;

            // 2. Service charge (applied AFTER discount)
            const hasService = document.getElementById('hasService').checked;
            const serviceRate = parseFloat(document.getElementById('serviceRate').value) || 10;
            const serviceAmt = hasService ? subtotalAfterDiscount * (serviceRate / 100) : 0;

            // 3. GST (applied to subtotal after discount + service)
            const taxable = subtotalAfterDiscount + serviceAmt;
            const hasGST = document.getElementById('hasGST').checked;
            const gstRate = parseFloat(document.getElementById('gstRate').value) || 9;
            const gstAmt = hasGST ? taxable * (gstRate / 100) : 0;

            // Total
            const total = taxable + gstAmt;

            // Update summary display
            document.getElementById('subtotalDisplay').textContent = `S$ ${subtotal.toFixed(2)}`;
            document.getElementById('discountRow').style.display = discountAmt > 0 ? 'flex' : 'none';
            document.getElementById('discountDisplay').textContent = `-S$ ${discountAmt.toFixed(2)}`;
            document.getElementById('subtotalAfterDiscountRow').style.display = discountAmt > 0 ? 'flex' : 'none';
            document.getElementById('subtotalAfterDiscountDisplay').textContent = `S$ ${subtotalAfterDiscount.toFixed(2)}`;
            document.getElementById('svcPct').textContent = serviceRate;
            document.getElementById('serviceRow').style.display = hasService ? 'flex' : 'none';
            document.getElementById('serviceDisplay').textContent = `S$ ${serviceAmt.toFixed(2)}`;
            document.getElementById('gstPct').textContent = gstRate;
            document.getElementById('gstRow').style.display = hasGST ? 'flex' : 'none';
            document.getElementById('gstDisplay').textContent = `S$ ${gstAmt.toFixed(2)}`;
            document.getElementById('totalDisplay').textContent = `S$ ${total.toFixed(2)}`;

            // Show/hide share actions
            const hasData = people.length > 0 && subtotal > 0;
            document.getElementById('shareActions').style.display = hasData ? 'flex' : 'none';

            // Check if total matches expected
            checkTotalMatch(total);

            // Calculate per-person breakdown
            calculatePersonBreakdown(subtotal, serviceAmt, discountAmt, gstAmt, total);
        }

        // Check if calculated total matches expected total
        function checkTotalMatch(calculatedTotal) {
            const expectedInput = document.getElementById('expectedTotal');
            const matchDiv = document.getElementById('totalMatch');
            const expected = parseFloat(expectedInput.value) || 0;

            if (expected <= 0) {
                matchDiv.className = 'total-match';
                matchDiv.innerHTML = '';
                return false;
            }

            if (calculatedTotal === undefined) {
                // Get current total from display
                const totalText = document.getElementById('totalDisplay').textContent;
                calculatedTotal = parseFloat(totalText.replace(/[^0-9.]/g, '')) || 0;
            }

            const diff = Math.abs(calculatedTotal - expected);

            if (diff < 0.05) {
                matchDiv.className = 'total-match match';
                matchDiv.innerHTML = `
                    <span class="match-icon">‚úÖ</span>
                    Total matches receipt!
                    <div class="match-hint">Safe to share with your team</div>
                `;
                return true;
            } else {
                matchDiv.className = 'total-match mismatch';
                const diffSign = calculatedTotal > expected ? '+' : '-';
                matchDiv.innerHTML = `
                    <span class="match-icon">‚ö†Ô∏è</span>
                    Difference: ${diffSign}S$${diff.toFixed(2)}
                    <div class="match-hint">Expected S$${expected.toFixed(2)} ‚Ä¢ Check items or bill options</div>
                `;
                return false;
            }
        }

        // Check if totals match before critical actions
        function isTotalMatched() {
            const expected = parseFloat(document.getElementById('expectedTotal').value) || 0;
            if (expected <= 0) return true; // No expected total set, allow action

            const totalText = document.getElementById('totalDisplay').textContent;
            const calculated = parseFloat(totalText.replace(/[^0-9.]/g, '')) || 0;
            return Math.abs(calculated - expected) < 0.05;
        }

        // Rounding helper
        function roundAmount(amount) {
            const roundType = document.getElementById('roundingType').value;
            if (roundType === 'none') return amount;
            const step = parseFloat(roundType);
            return Math.ceil(amount / step) * step;
        }
        
        function calculatePersonBreakdown(subtotal, serviceAmt, discountAmt, gstAmt, total) {
            const breakdownList = document.getElementById('breakdownList');
            
            if (people.length === 0) {
                breakdownList.innerHTML = '<div class="no-items">Add people to see breakdown</div>';
                return;
            }
            
            // Calculate each person's share
            const personData = people.map(person => {
                // Get items for this person
                const personItems = items.filter(item => item.people.includes(person));
                
                // Calculate their subtotal (split shared items)
                let personSubtotal = 0;
                const itemDetails = [];
                
                personItems.forEach(item => {
                    const shareCount = item.people.length || 1;
                    const share = (item.price || 0) / shareCount;
                    personSubtotal += share;
                    if (item.price > 0) {
                        itemDetails.push({
                            name: item.name || 'Item',
                            price: item.price,
                            share: share,
                            shared: shareCount > 1 ? shareCount : 0
                        });
                    }
                });
                
                // Calculate proportion of extras (discount first, then service on discounted amount)
                const proportion = subtotal > 0 ? personSubtotal / subtotal : 0;
                const personDiscount = discountAmt * proportion;
                const personSubtotalAfterDiscount = personSubtotal - personDiscount;
                const personService = serviceAmt * proportion;
                const personGst = gstAmt * proportion;
                const exactTotal = personSubtotalAfterDiscount + personService + personGst;
                const personTotal = roundAmount(exactTotal);

                return {
                    name: person,
                    items: itemDetails,
                    subtotal: personSubtotal,
                    discount: personDiscount,
                    service: personService,
                    gst: personGst,
                    exactTotal: exactTotal,
                    total: personTotal
                };
            });
            
            // Render breakdown
            breakdownList.innerHTML = personData.map((p, idx) => {
                const isPaid = paidStatus[p.name] || false;
                return `
                <div class="person-breakdown">
                    <div class="person-header ${isPaid ? 'paid' : ''}" onclick="toggleDetails(${idx})">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span class="person-name">${p.name}</span>
                            ${isPaid ? '<span style="font-size: 12px;">‚úì Paid</span>' : ''}
                        </div>
                        <div style="display: flex; align-items: center;">
                            <span class="person-total">S$ ${p.total.toFixed(2)}</span>
                            <button class="paid-btn ${isPaid ? 'is-paid' : ''}" onclick="event.stopPropagation(); togglePaid('${p.name}')">
                                ${isPaid ? '‚úì Paid' : 'Mark Paid'}
                            </button>
                        </div>
                    </div>
                    <div class="person-details" id="details${idx}">
                        ${p.items.length > 0 ? p.items.map(item => `
                            <div class="detail-row item">
                                <span>${item.name} ${item.shared > 1 ? `<span class="shared">(√∑${item.shared})</span>` : ''}</span>
                                <span>S$ ${item.share.toFixed(2)}</span>
                            </div>
                        `).join('') : '<div class="detail-row"><span>No items</span><span>S$ 0.00</span></div>'}
                        ${p.service > 0 ? `<div class="detail-row"><span>Service</span><span>S$ ${p.service.toFixed(2)}</span></div>` : ''}
                        ${p.discount > 0 ? `<div class="detail-row"><span>Discount</span><span class="negative">-S$ ${p.discount.toFixed(2)}</span></div>` : ''}
                        ${p.gst > 0 ? `<div class="detail-row"><span>GST</span><span>S$ ${p.gst.toFixed(2)}</span></div>` : ''}
                        <button class="generate-person-btn" onclick="generateQR('${p.name}', ${p.total.toFixed(2)})">
                            Generate PayNow QR
                        </button>
                    </div>
                </div>
            `}).join('');
        }

        // Toggle paid status
        function togglePaid(name) {
            paidStatus[name] = !paidStatus[name];
            calculate();
            showToast(paidStatus[name] ? `${name} marked as paid` : `${name} marked as unpaid`);
        }
        
        function toggleDetails(idx) {
            const details = document.getElementById(`details${idx}`);
            details.classList.toggle('show');
        }
        
        // PayNow QR Generation
        function calculateCRC(str) {
            let crc = 0xFFFF;
            for (let i = 0; i < str.length; i++) {
                crc ^= str.charCodeAt(i) << 8;
                for (let j = 0; j < 8; j++) {
                    crc = (crc & 0x8000) ? (crc << 1) ^ 0x1021 : crc << 1;
                }
            }
            return (crc & 0xFFFF).toString(16).toUpperCase().padStart(4, '0');
        }
        
        function tlv(tag, value) {
            return tag + value.length.toString().padStart(2, '0') + value;
        }
        
        function generatePayNowString(amount, reference) {
            let merchantAcctInfo = '';
            merchantAcctInfo += tlv('00', 'SG.PAYNOW');
            merchantAcctInfo += tlv('01', '0');
            merchantAcctInfo += tlv('02', '+6583399525');
            merchantAcctInfo += tlv('03', '1');
            
            let payload = '';
            payload += tlv('00', '01');
            payload += tlv('01', '12');
            payload += tlv('26', merchantAcctInfo);
            payload += tlv('52', '0000');
            payload += tlv('53', '702');
            
            if (amount && parseFloat(amount) > 0) {
                payload += tlv('54', parseFloat(amount).toFixed(2));
            }
            
            payload += tlv('58', 'SG');
            payload += tlv('59', 'NA');
            payload += tlv('60', 'Singapore');
            
            if (reference && reference.trim()) {
                payload += tlv('62', tlv('01', reference.trim().substring(0, 25)));
            }
            
            payload += '6304';
            payload += calculateCRC(payload);
            
            return payload;
        }
        
        function generateQR(name, amount) {
            const qrDiv = document.getElementById('qrcode');
            qrDiv.innerHTML = '';
            
            const today = new Date().toLocaleDateString('en-GB', { day: 'numeric', month: 'short' });
            const reference = `${name} ${today}`;
            const payNowString = generatePayNowString(amount, reference);
            
            qrcode = new QRCode(qrDiv, {
                text: payNowString,
                width: 180,
                height: 180,
                colorDark: '#7B2D8E',
                colorLight: '#ffffff',
                correctLevel: QRCode.CorrectLevel.M
            });
            
            document.getElementById('modalName').textContent = name;
            document.getElementById('modalAmount').textContent = `S$ ${parseFloat(amount).toFixed(2)}`;
            document.getElementById('qrModal').classList.add('show');
        }
        
        function closeModal(event) {
            if (!event || event.target === document.getElementById('qrModal')) {
                document.getElementById('qrModal').classList.remove('show');
            }
        }
        
        function downloadQR() {
            const canvas = document.querySelector('#qrcode canvas');
            if (canvas) {
                const name = document.getElementById('modalName').textContent;
                const link = document.createElement('a');
                link.download = `paynow-${name.toLowerCase().replace(/\s+/g, '-')}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
            }
        }

        // ==================== SHARING ====================

        // Generate share text
        function generateShareText() {
            const today = new Date().toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });
            let text = `üçú Lunch Split - ${today}\n\n`;

            const personData = getPersonData();
            personData.forEach(p => {
                if (p.total > 0) {
                    text += `${p.name}: S$${p.total.toFixed(2)}\n`;
                }
            });

            const total = personData.reduce((sum, p) => sum + p.total, 0);
            text += `\nüí∞ Total: S$${total.toFixed(2)}`;
            text += `\n\nPayNow to +65 8339 9525`;

            return text;
        }

        // Get person data for sharing
        function getPersonData() {
            let subtotal = 0;
            items.forEach(item => subtotal += item.price || 0);

            const hasService = document.getElementById('hasService').checked;
            const serviceRate = parseFloat(document.getElementById('serviceRate').value) || 10;
            const serviceAmt = hasService ? subtotal * (serviceRate / 100) : 0;

            const discountValue = parseFloat(document.getElementById('discountValue').value) || 0;
            const discountType = document.getElementById('discountType').value;
            let discountAmt = discountType === 'percent' ? subtotal * (discountValue / 100) : discountValue;

            const taxable = subtotal + serviceAmt - discountAmt;
            const hasGST = document.getElementById('hasGST').checked;
            const gstRate = parseFloat(document.getElementById('gstRate').value) || 9;
            const gstAmt = hasGST ? taxable * (gstRate / 100) : 0;

            return people.map(person => {
                const personItems = items.filter(item => item.people.includes(person));
                let personSubtotal = 0;
                personItems.forEach(item => {
                    const shareCount = item.people.length || 1;
                    personSubtotal += (item.price || 0) / shareCount;
                });

                const proportion = subtotal > 0 ? personSubtotal / subtotal : 0;
                const exactTotal = personSubtotal + (serviceAmt * proportion) - (discountAmt * proportion) + (gstAmt * proportion);
                return { name: person, total: roundAmount(exactTotal) };
            });
        }

        // Share via WhatsApp
        function shareWhatsApp() {
            if (!isTotalMatched()) {
                if (!confirm('‚ö†Ô∏è Total doesn\'t match receipt!\n\nAre you sure you want to share anyway?')) {
                    return;
                }
            }
            const text = encodeURIComponent(generateShareText());
            window.open(`https://wa.me/?text=${text}`, '_blank');
        }

        // Copy share link
        function copyShareLink() {
            if (!isTotalMatched()) {
                if (!confirm('‚ö†Ô∏è Total doesn\'t match receipt!\n\nAre you sure you want to copy the link anyway?')) {
                    return;
                }
            }
            const data = {
                p: people,
                i: items.map(it => ({ n: it.name, pr: it.price, ppl: it.people })),
                svc: document.getElementById('hasService').checked ? parseFloat(document.getElementById('serviceRate').value) : 0,
                gst: document.getElementById('hasGST').checked ? parseFloat(document.getElementById('gstRate').value) : 0,
                disc: parseFloat(document.getElementById('discountValue').value) || 0,
                discType: document.getElementById('discountType').value
            };
            const encoded = btoa(encodeURIComponent(JSON.stringify(data)));
            const url = `${window.location.origin}${window.location.pathname}?d=${encoded}`;

            navigator.clipboard.writeText(url).then(() => {
                showToast('Link copied to clipboard!');
            }).catch(() => {
                showToast('Failed to copy link');
            });
        }

        // Check URL params for shared data
        function checkUrlParams() {
            const params = new URLSearchParams(window.location.search);
            const data = params.get('d');
            if (data) {
                try {
                    const decoded = JSON.parse(decodeURIComponent(atob(data)));
                    people = decoded.p || [];
                    items = (decoded.i || []).map((it, idx) => ({
                        id: idx,
                        name: it.n,
                        price: it.pr,
                        people: it.ppl
                    }));
                    itemIdCounter = items.length;

                    if (decoded.svc > 0) {
                        document.getElementById('hasService').checked = true;
                        document.getElementById('serviceRate').value = decoded.svc;
                    }
                    if (decoded.gst > 0) {
                        document.getElementById('hasGST').checked = true;
                        document.getElementById('gstRate').value = decoded.gst;
                    }
                    if (decoded.disc > 0) {
                        document.getElementById('discountValue').value = decoded.disc;
                        document.getElementById('discountType').value = decoded.discType || 'amount';
                    }

                    renderPeople();
                    renderItems();
                    calculate();
                    showToast('Loaded shared bill');

                    // Clear URL params
                    window.history.replaceState({}, '', window.location.pathname);
                } catch (e) {
                    console.error('Error loading shared data:', e);
                }
            }
        }

        // ==================== HISTORY ====================

        // Save current split to history
        function saveToHistory() {
            const today = new Date();
            const personData = getPersonData();
            const total = personData.reduce((sum, p) => sum + p.total, 0);

            const entry = {
                id: Date.now(),
                date: today.toISOString(),
                people: [...people],
                items: items.map(it => ({ name: it.name, price: it.price, people: it.people })),
                total: total,
                breakdown: personData
            };

            splitHistory.unshift(entry);
            if (splitHistory.length > 50) splitHistory.pop(); // Keep last 50
            saveHistoryToStorage();
            renderHistory();
            showToast('Saved to history');
        }

        // Render history list
        function renderHistory() {
            const list = document.getElementById('historyList');
            if (splitHistory.length === 0) {
                list.innerHTML = '<div class="no-items">No saved splits yet</div>';
                return;
            }

            list.innerHTML = splitHistory.map(entry => {
                const date = new Date(entry.date);
                const dateStr = date.toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });
                const timeStr = date.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
                return `
                    <div class="history-item" onclick="loadHistory(${entry.id})">
                        <div class="history-info">
                            <div class="history-date">${dateStr} ${timeStr}</div>
                            <div class="history-people">${entry.people.join(', ')}</div>
                        </div>
                        <div class="history-total">S$ ${entry.total.toFixed(2)}</div>
                        <button class="history-delete" onclick="event.stopPropagation(); deleteHistory(${entry.id})">√ó</button>
                    </div>
                `;
            }).join('');
        }

        // Load a history entry
        function loadHistory(id) {
            const entry = splitHistory.find(e => e.id === id);
            if (!entry) return;

            people = [...entry.people];
            items = entry.items.map((it, idx) => ({
                id: idx,
                name: it.name,
                price: it.price,
                people: it.people
            }));
            itemIdCounter = items.length;

            renderPeople();
            renderItems();
            renderSavedTeam();
            calculate();
            switchTab('split');
            showToast('Loaded from history');
        }

        // Delete history entry
        function deleteHistory(id) {
            splitHistory = splitHistory.filter(e => e.id !== id);
            saveHistoryToStorage();
            renderHistory();
            showToast('Deleted from history');
        }

        // Clear all history
        function clearHistory() {
            if (confirm('Clear all history?')) {
                splitHistory = [];
                saveHistoryToStorage();
                renderHistory();
                showToast('History cleared');
            }
        }

        // ==================== Receipt Scanning (ai.insea.io API) ====================

        const INSEA_API_KEY = 'yz1PZMqqNAQRVXeOmie0gkaDft9I2l0R';
        const INSEA_API_URL = 'https://ai.insea.io/api/workflows/10902/run';

        // Handle receipt upload
        async function handleReceiptUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const status = document.getElementById('ocrStatus');
            status.className = 'ocr-status show';
            status.textContent = 'Uploading receipt...';

            try {
                // Create FormData and send to ai.insea.io
                const formData = new FormData();
                formData.append('receipt_image', file);

                status.textContent = 'Analyzing receipt with AI...';

                const response = await fetch(INSEA_API_URL, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${INSEA_API_KEY}`
                    },
                    body: formData
                });

                if (!response.ok) {
                    throw new Error(`API error: ${response.status}`);
                }

                const result = await response.json();
                console.log('API Response:', result);

                // Parse the response from the API
                const outputs = result.data?.outputs || {};
                const splitResult = outputs.split_result || '';
                const extracted = parseInseaResult(splitResult);

                // Auto-fill bill options if provided
                if (outputs.service_charge && outputs.service_charge > 0) {
                    document.getElementById('hasService').checked = true;
                    // Calculate service charge percentage from subtotal after discount
                    const subtotalAfterDiscount = (outputs.subtotal || 0) - (outputs.discount || 0);
                    if (subtotalAfterDiscount > 0) {
                        const svcPct = (outputs.service_charge / subtotalAfterDiscount * 100).toFixed(1);
                        document.getElementById('serviceRate').value = svcPct;
                    }
                }
                if (outputs.discount && outputs.discount > 0) {
                    document.getElementById('discountValue').value = outputs.discount.toFixed(2);
                    document.getElementById('discountType').value = 'amount';
                }
                // Auto-fill expected total (grand_total from receipt)
                if (outputs.grand_total && outputs.grand_total > 0) {
                    document.getElementById('expectedTotal').value = outputs.grand_total.toFixed(2);
                }

                if (extracted.length > 0) {
                    // Show preview instead of adding directly
                    showOcrPreview(extracted);
                    status.textContent = `Found ${extracted.length} items - review below`;
                    setTimeout(() => { status.className = 'ocr-status'; }, 3000);
                } else {
                    status.className = 'ocr-status show error';
                    const rawText = typeof splitResult === 'string' ? splitResult : JSON.stringify(splitResult);
                    status.innerHTML = `No items found. <button onclick="showRawOcrText(\`${rawText.replace(/`/g, "'").replace(/\\/g, "\\\\").replace(/\n/g, "\\n")}\`)" style="margin-left:8px;padding:4px 8px;border:1px solid #c62828;background:white;border-radius:4px;cursor:pointer;">View Raw Text</button>`;
                }
            } catch (e) {
                console.error('API error:', e);
                status.className = 'ocr-status show error';
                status.textContent = 'Error analyzing receipt. Please try again.';
            }

            event.target.value = '';
        }

        // Parse the ai.insea.io result format
        function parseInseaResult(data) {
            console.log('Parsing result:', data);
            const items = [];

            // Handle JSON array format (new workflow)
            if (typeof data === 'string') {
                try {
                    data = JSON.parse(data);
                } catch (e) {
                    // Not JSON, try legacy text parsing
                    return parseLegacyTextFormat(data);
                }
            }

            // If it's an array of items
            if (Array.isArray(data)) {
                data.forEach(item => {
                    if (item.name && item.price !== undefined) {
                        items.push({
                            name: item.name,
                            price: parseFloat(item.price)
                        });
                    }
                });
            }

            console.log('Extracted items:', items);
            return items;
        }

        // Legacy text format parser (fallback)
        function parseLegacyTextFormat(text) {
            const items = [];
            const itemPattern = /^\d+\.\s*(.+?)\s*-\s*\$?([\d.]+)\s*$/gm;

            let match;
            while ((match = itemPattern.exec(text)) !== null) {
                let name = match[1].trim().replace(/\*\*/g, '');
                const price = parseFloat(match[2]);

                const skipWords = ['subtotal', 'total', 'discount', 'gst', 'tax', 'service', 'rounding', 'grand'];
                if (skipWords.some(word => name.toLowerCase().includes(word))) continue;

                if (price > 0 && price < 200 && name.length > 0) {
                    items.push({ name, price });
                }
            }
            return items;
        }

        // Show OCR preview modal
        function showOcrPreview(extractedItems) {
            pendingOcrItems = extractedItems.map((item, idx) => ({
                ...item,
                selected: true,
                id: idx
            }));

            renderOcrPreview();
            document.getElementById('previewModal').classList.add('show');
        }

        // Render OCR preview items
        function renderOcrPreview() {
            const container = document.getElementById('previewItems');
            const selectedCount = pendingOcrItems.filter(i => i.selected).length;
            document.getElementById('previewCount').textContent = `${selectedCount} selected`;

            container.innerHTML = pendingOcrItems.map(item => `
                <div class="preview-item">
                    <input type="checkbox" ${item.selected ? 'checked' : ''}
                        onchange="toggleOcrItem(${item.id})">
                    <span class="preview-item-name">${item.name}</span>
                    <span class="preview-item-price">S$ ${item.price.toFixed(2)}</span>
                </div>
            `).join('');
        }

        // Toggle OCR item selection
        function toggleOcrItem(id) {
            const item = pendingOcrItems.find(i => i.id === id);
            if (item) {
                item.selected = !item.selected;
                renderOcrPreview();
            }
        }

        // Close preview modal
        function closePreview() {
            document.getElementById('previewModal').classList.remove('show');
            pendingOcrItems = [];
        }

        // Confirm and add selected OCR items
        function confirmPreview() {
            const selected = pendingOcrItems.filter(i => i.selected);
            selected.forEach(item => {
                items.push({
                    id: itemIdCounter++,
                    name: item.name,
                    price: item.price,
                    people: [...people]
                });
            });

            renderItems();
            calculate();
            closePreview();
            showToast(`Added ${selected.length} items`);
        }

        // Manual entry fallback - show raw API result for user to copy
        function showRawOcrText(text) {
            const cleanText = text.replace(/\\n/g, '\n').replace(/\n+/g, '\n').trim();
            alert('API Result (copy items manually):\n\n' + cleanText);
        }

        // Initialize
        init();
    </script>
</body>
</html>
